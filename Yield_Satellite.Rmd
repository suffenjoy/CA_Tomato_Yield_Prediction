---
title: "Yield_Satellite"
author: "Zhehan"
date: "12/11/2020"
output: html_document
---

#Package
```{r}
library(ggplot2)
library(gridExtra)
library(chillR)
library(Hmisc)
library(tidyr)
library(dplyr)
library(ggspatial)
library(raster)
library(viridis)
library(stringr)
library(sp)
library(readxl)
library(ggsci)
library(lubridate)
library(caret)
library(RColorBrewer)
library(corrplot)
library(imputeTS)
library(caret)
library(pdp)
library(qdapRegex)
library(signal)
library(phenofit)
library(TDPanalysis)
library(ggpubr)
library(ggmap)
library(pollen)
library(stringr)
```
#Read commisioner yield data
https://www.nass.usda.gov/Statistics_by_State/California/Publications/AgComm/index.php
```{r}
path_yield <- "D:/Tomato_Phenology_RemoteSensing/Historical_Yield_Raw"
yield_2008_2019 <- read_excel(file.path(path_yield, "Processing Tomato Yield 2008-2019.xlsx"))
head(yield_2008_2019)
sum(is.na(yield_2008_2019)) #o NA
names(yield_2008_2019) <- c("County","Year","TotalYield","Yield","Area")
dim(yield_2008_2019)  #165,5

p1 <- ggscatter(yield_2008_2019, x = "Year", y = "Yield", add = "reg.line") +stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~")),label.x = 2008, label.y = 61) + stat_regline_equation(label.x = 2008, label.y = 58) + scale_x_continuous(breaks = c(2008,2011,2014,2017, 2020)) + ylab("Yield (tons/acre)")
p1
facet(p1 + theme_bw(), facet.by = "County")
length(unique(yield_2008_2019$County))
yield_2008_2019 %>% group_by(County) %>% summarise(length(Yield), mean(Area), mean(Yield))

```

#Read yield Data
```{r}
path_report <- "C:/Users/tangz/Box Sync/Tomato_Phenology_RemoteSensing/Historic_Yield_Data/Annual_Report"
yield_county_report <- read_excel(file.path(path_report, "Processing Tomato Yield.xlsx"), sheet = 1, skip = 2)
yield_county_report <- gather(yield_county_report, Year, Yield, '1999':'2019')
head(yield_county_report)
names(yield_county_report)[1] <- "County"

ggplot(yield_county_report, aes(x  = Year, y = Yield, color = County)) + geom_point() + theme_bw()

totyield_county_report <- read_excel(file.path(path_report, "Processing Tomato Yield.xlsx"), sheet = 2, skip = 2)
totyield_county_report <- gather(totyield_county_report, Year, TotalYield, '1999':'2019')
names(totyield_county_report)[1] <- "County"
head(totyield_county_report)

#combine 
yield_county_report <- base::merge(totyield_county_report,yield_county_report,by = c("County","Year"))
head(yield_county_report)

#add area 
yield_county_report$Area <- yield_county_report$TotalYield/yield_county_report$Yield

#remove the outlier 
yield_county_report <- subset(yield_county_report, Yield < 65)
dim(yield_county_report) #237,5
head(yield_county_report)  

yield_county_report_2008_2019 <- subset(yield_county_report, Year >= 2008 & Year <= 2019)
dim(yield_county_report_2008_2019) #135,5
names(yield_county_report_2008_2019) #"County"     "Year"       "TotalYield" "Yield"      "Area"    
yield_county_report_2008_2019 %>% group_by(County) %>% summarise(sum(is.na(Yield)))

ggplot(yield_county_report_2008_2019, aes(x = Year, y = Yield)) + geom_point() + facet_wrap(~County) + geom_smooth(method = "lm", se = FALSE) + theme_bw() 

yield_county_report_2008_2019 <- na.omit(yield_county_report_2008_2019)



p1 <- ggscatter(yield_county_report_2008_2019, x = "Year", y = "Yield", add = "reg.line") +stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~")),label.x = 2008, label.y = 61) + stat_regline_equation(label.x = 2008, label.y = 58) + scale_x_continuous(breaks = c(2008,2011,2014,2017, 2020)) + ylab("Yield (tons/acre)")
p1
facet(p1 + theme_bw(), facet.by = "County")

```
##Compare two yield dataset
```{r}
yield_compare <- merge(yield_2008_2019, yield_county_report, by = c("Year","County"))
dim(yield_compare)#136,8
head(yield_compare) 
names(yield_compare) <- c("Year","County","TotalYield_NASS","Yield_NASS","Area_NASS","TotalYield_Report","Yield_Report","Area_Report")
dim(yield_compare) #136,8
dim(yield_2008_2019) #165,5
dim(na.omit(subset(yield_county_report, Year >= 2008))) #136,5
dim(na.omit(subset(yield_county_nass, Year >= 2008 & County != "OTHER (COMBINED) COUNTIES")))  #122,4
View(na.omit(subset(yield_county_nass, Year >= 2008 & County != "OTHER (COMBINED) COUNTIES"))) 
yield_county_nass <- na.omit(subset(yield_county_nass, Year >= 2008 & County != "OTHER (COMBINED) COUNTIES"))
names(yield_county_nass)[4] <- "Yield"
yield_county_nass$County <- stringr::str_to_title(yield_county_nass$County)
yield_compare_2 <- merge(yield_county_nass, yield_2008_2019, by = c("Year","County"))
head(yield_compare_2)
dim(yield_compare_2) #112,7
names(yield_compare_2)[c(4,6)] <- c("Yield_NASS","Yield_Report")
ggplot(yield_compare_2, aes(x = Yield_NASS, y = Yield_Report)) + geom_point() + geom_abline(slope = 1, intercept = 0) + xlim(30,70) + ylim(30,70) 

names(yield_county_nass)[4] <- 
ggplot(yield_compare, aes(x = TotalYield_NASS, y = TotalYield_Report)) + geom_point() + geom_abline(slope = 1, intercept = 0)
ggplot(yield_compare, aes(x = Yield_NASS, y = Yield_Report)) + geom_point() + geom_abline(slope = 1, intercept = 0)
subset(yield_compare, Yield_NASS < 45 & Yield_Report > 45)
abs(yield_compare$Yield_NASS - yield_compare$Yield_Report)

ggplot(yield_compare, aes(x = Area_NASS, y = Area_Report)) + geom_point() + geom_abline(slope = 1, intercept = 0)
View(yield_2008_2019)
View(yield_county_report)

years <- 2008:2019
for(i in 1:12){
  CA_counties_yield <- CA_counties
  CA_counties_yield <- subset(CA_counties_yield, NAME %in% subset(yield_2008_2019, Year==years[i])$County)
  plot(CA_counties_yield)
  CA_counties_yield@data <- merge(CA_counties@data[,c("NAME","INTPTLAT","INTPTLON")], subset(yield_2008_2019,Year==years[i]), by.x = "NAME", by.y = "County")
  #sp_yield <- list("Yield",CA_counties_yield,  col = TRUE)
  #spplot(CA_counties, "STATEFP", col = TRUE)
  #sp::plot(CA_counties)
  spplot(CA_counties_yield, "Yield", col = "transparent", col.regions = brewer.pal(n=9, name = "OrRd"), cuts = 7)
  #spplot(CA_counties, "STATEFP", col = TRUE) 
}
```

##Combine them together to produce yield_county
```{r}
unique(yield_2008_2019$County)
yield_county <- subset(yield_2008_2019, County!="Glenn" & County!="San Benito" & County!= "Santa Clara")
yield_county <- subset(yield_county, Yield < 65)
dim(yield_county) #142,5

yield_county_2 <- subset(yield_county, County != "Contra Costa")
dim(yield_county_2) #135

dim(yield_2008_2019)
dim(yield_county_report_2008_2019) #135

p1 <- ggscatter(yield_county, x = "Year", y = "Yield", add = "reg.line") +stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~")),label.x = 2008, label.y = 61) + stat_regline_equation(label.x = 2008, label.y = 57) + scale_x_continuous(breaks = c(2008,2011,2014,2017, 2020)) + ylab("Yield (tons/acre)")
p1
facet(p1 + theme_bw(), facet.by = "County")

```

##Calculate detrend by county 
###Detrend by county 
```{r}
#calculate the trend by the entire state
lm_trend_state <- lm(Yield ~ Year, data = yield_county)
summary(lm_trend_state) #R2 = 0.1132
#detrend 
yield_county$detrend_state <- lm_trend_state$residuals

#calculate the trend by each county 
lm_trend_county <- yield_county %>% group_by(County) %>% summarise("Year" = Year,"detrend_county"= lm(Yield~Year)$residuals)
yield_county <- merge(yield_county, lm_trend_county, by = c("County","Year"))
dim(yield_county)

#calculate the mean by each county 
mean_county <- yield_county %>% group_by(County) %>% summarise("Year" = Year, "mean_county" = mean(Yield))
yield_county <- merge(yield_county, mean_county, by = c("County","Year"))
dim(yield_county)  #142,8

#add detrend + mean column 
yield_county$detrend_county_mean <- yield_county$detrend_county + yield_county$mean_county
yield_county$detrend_state_mean <- yield_county$detrend_state + yield_county$mean_county
head(yield_county)

#histogram 
p1 = gghistogram(yield_county, x = "Yield", add = "mean", fill = "gray",  xlab = "Yield (tons/acre)", ylab = "# Count") + theme_bw()
p2 = gghistogram(yield_county, x = "detrend_county", add = "mean", fill = "gray",  xlab = "Detrended Yield (tons/acre)", ylab = "# Count") + theme_bw()
p3 = gghistogram(yield_county, x = "detrend_county_mean", add = "mean", fill = "gray",  xlab = "Detrended+Mean Yield (tons/acre)", ylab = "# Count") + theme_bw()
#scatter plot 
p4 = ggscatter(yield_county, x = "Year", y = "Yield", add = "reg.line") + ylab("Yield (tons/acre)") + scale_x_continuous(breaks = seq(2009, 2019, 3)) + theme_bw()
p5 = ggscatter(yield_county, x = "Year", y = "detrend_county", add = "reg.line") + ylab("Detrended Yield (tons/acre)") + scale_x_continuous(breaks = seq(2009, 2019, 3)) + theme_bw()
p6 = ggscatter(yield_county, x = "Year", y = "detrend_county_mean", add = "reg.line") + ylab("Detrended+Mean Yield (tons/acre)") + scale_x_continuous(breaks = seq(2009, 2019, 3)) + theme_bw()
#plot together 
grid.arrange(p1,p2,p3,p4,p5,p6, nrow = 2, ncol = 3)


```

##Plot yield in the map
```{r}
yield_county %>% group_by(Year) %>% summarise(length(County))
dim(yield_county) #142,10

#the field boundary dataframe 
county_positions <- map_data("county")
county_positions <- dplyr::filter(county_positions, region == "california")
dim(county_positions) #2977,6
county_positions$subregion <- stringr::str_to_title(county_positions$subregion)
head(county_positions)


#merge with annual yield data
county_positions_yield <- base::merge(county_positions, subset(yield_county), by.x = "subregion", by.y = "County", all.x = TRUE)
county_positions_yield <- county_positions_yield[order(county_positions_yield$order),]
county_positions_yield <- subset(county_positions_yield, !is.na(Yield))

ggplot(county_positions_yield, aes(x = long, y = lat, group = group, fill = Yield)) +geom_polygon(color = "black")+ scale_fill_viridis_b(breaks = seq(35,65,length = 9),alpha = 0.6, na.value = "white")+labs(fill = "Yield (tons/acre)") + theme_minimal() + facet_wrap(~Year, ncol = 4, nrow = 3)

```


#Read field name
```{r}
#path_shp <- "C:/Users/tangz/Box Sync/Tomato_Phenology_RemoteSensing/Shapefiles"
#path_fidbound <- "C:/Users/tangz/Box Sync/Tomato_Phenology_RemoteSensing/Shapefiles/tomato_fidbound"
path_shp <- "D:/Tomato_Phenology_RemoteSensing/Shapefiles"

ls_tomato_fidbound <- list()
shp_list <- list.files(path_shp, pattern = "gee.shp", full.names = TRUE)
for(i in 1:length(shp_list)){
  ls_tomato_fidbound[[i]] <- shapefile(shp_list[i])
}

path_shp_box <- "C:/Users/tangz/Box Sync/Tomato_Phenology_RemoteSensing/Shapefiles"
CA_counties <- shapefile(file.path(path_shp_box,"CA_Counties_TIGER2016.shp"))
plot(CA_counties)
ls_tomato_fidbound

projection_tomato<- ls_tomato_fidbound[[1]]@proj4string

CA_counties <- spTransform(CA_counties, projection_tomato)
plot(CA_counties)
plot(ls_tomato_fidbound[[1]], add = TRUE, col = "red", border = "transparent")

```

#Add field ID and center location
```{r}
for(i in 1:length(ls_tomato_fidbound)){
  ls_tomato_fidbound[[i]]$ID <- 1:nrow(ls_tomato_fidbound[[i]])
  ls_tomato_fidbound[[i]]$Year <- 2007+i
  ls_tomato_fidbound[[i]]$ID_year <- paste(ls_tomato_fidbound[[i]]$Year, ls_tomato_fidbound[[i]]$ID, sep = "_")
  ls_tomato_fidbound[[i]]$Longitude <- rgeos::gCentroid(ls_tomato_fidbound[[i]], byid = TRUE)@coords[,1]
  ls_tomato_fidbound[[i]]$Latitude <- rgeos::gCentroid(ls_tomato_fidbound[[i]], byid = TRUE)@coords[,2]
}

names(ls_tomato_fidbound) <- paste("Year",2008:2019,sep = "_")

```

#Read GEE output
##Landsat 5
```{r}
path_l5sr_ts <- "D:/Tomato_Phenology_RemoteSensing/GEE_output/Landsat5sr_ts"
l5sr_ts_names <- list.files(path_l5sr_ts, full.names = TRUE, pattern = ".csv")
l5sr_ts_names
l5sr_ts_list <- list()

read_l5sr_ts <- function(filenames){
  ts <- read.csv(filenames)
  names(ts)[4] <- "Date"
  ts <- ts[,c("Area_acre","County","Date","mean")]
  ts$Date <- as.character(ts$Date)
  ts$Date <- as.Date(sapply(strsplit(ts$Date,split = "_"),'[',3),"%Y%m%d")
  #remove NAs
  ts <- na.omit(ts)
  #if there are two values per date, average it 
  ts <- aggregate(ts$mean, by = list("Date" = ts$Date,"Area_acre" = ts$Area_acre,"County" = ts$County), FUN = mean)
  #add band name
  names(ts)[4] <- "mean"
  ts$Band <- unlist(ex_between(filenames, left = "L5_", right = "_20", extract = TRUE))
  #scale the value 
  if(unique(ts$Band) != "B6"){
    ts$mean <- ts$mean * 0.0001
  }
  if(unique(ts$Band) == "B6"){
    ts$mean <- ts$mean * 0.1
  }
  return(ts)
}
#Apply the function 
for(i in 1:length(l5sr_ts_names)){
  l5sr_ts_list[[i]] <- read_l5sr_ts(filenames = l5sr_ts_names[i])
}
head(l5sr_ts_list[[1]])
dim(l5sr_ts_list[[1]])

#change the list to df
l5sr_ts_df <- do.call(rbind, l5sr_ts_list)
dim(l5sr_ts_df) #7182747,5
#convert long to wide 
l5sr_ts_df <- spread(l5sr_ts_df, key = "Band",value = "mean")
head(l5sr_ts_df)

```
###Calculate vis
####Function
```{r}
ndvi_l57 <- function(df){
  red <- df$B3
  nir <- df$B4
  NDVI <- (nir-red)/(nir+red)
  return(NDVI)
}
evi_l57 <- function(df){
  red <- df$B3
  nir <- df$B4
  blue <- df$B1
  EVI <- 2.5*(nir-red)/(nir+6*red-7.5*blue+1)
  return(EVI)
}

evi2_l57 <- function(df){
  red <- df$B3
  nir <- df$B4
  EVI2 <- 2.4*(nir-red)/(nir+red+1)
  return(EVI2)
}

wdrvi_l57 <- function(df){
  nir <- df$B4
  red <- df$B3
  alpha <- 0.1
  WDRVI <- (alpha*nir - red)/(alpha*nir + red)
  return(WDRVI)
}

ndmi_l57 <- function(df){
  nir <- df$B4
  swir <- df$B5
  NDMI <- (nir-swir)/(nir+swir)
  return(NDMI)
}

addVIs_l57 <- function(df){
  df$NDVI <- ndvi_l57(df)
  df$EVI <- evi_l57(df)
  df$EVI2 <- evi2_l57(df)
  df$WDRVI <- wdrvi_l57(df)
  df$NDMI <- ndmi_l57(df)
  return(df)
}
```

####Apply the function
```{r}
l5sr_ts_df <- addVIs_l57(l5sr_ts_df)
head(l5sr_ts_df)
```
###Calculate vis 
####Apply the function
```{r}
l7sr_ts_df <- addVIs_l57(l7sr_ts_df)
head(l7sr_ts_df)
```

##Landsat 7
```{r}
path_l7sr_ts <- "D:/Tomato_Phenology_RemoteSensing/GEE_output/Landsat7sr_ts"
l7sr_ts_names <- list.files(path_l7sr_ts, full.names = TRUE, pattern = ".csv")
l7sr_ts_names
l7sr_ts_list <- list()

read_l7sr_ts <- function(filenames){
  ts <- read.csv(filenames)
  names(ts)[4] <- "Date"
  ts <- ts[,c("Area_acre","County","Date","mean")]
  ts$Date <- as.character(ts$Date)
  ts$Date <- as.Date(sapply(strsplit(ts$Date,split = "_"),'[',3),"%Y%m%d")
  #remove NAs
  ts <- na.omit(ts)
  #if there are two values per date, average it 
  ts <- aggregate(ts$mean, by = list("Date" = ts$Date,"Area_acre" = ts$Area_acre,"County" = ts$County), FUN = mean)
  #add band name
  names(ts)[4] <- "mean"
  ts$Band <- unlist(ex_between(filenames, left = "L7_", right = "_20", extract = TRUE))
  #scale the value 
  if(unique(ts$Band) != "B6"){
    ts$mean <- ts$mean * 0.0001
  }
  if(unique(ts$Band) == "B6"){
    ts$mean <- ts$mean * 0.1
  }
  return(ts)
}
#Apply the function 
for(i in 1:length(l7sr_ts_names)){
  l7sr_ts_list[[i]] <- read_l7sr_ts(filenames = l7sr_ts_names[i])
}
head(l7sr_ts_list[[1]])
dim(l7sr_ts_list[[1]])

#change the list to df
l7sr_ts_df <- do.call(rbind, l7sr_ts_list)
dim(l7sr_ts_df) #7182747,5
#convert long to wide 
l7sr_ts_df <- spread(l7sr_ts_df, key = "Band",value = "mean")
head(l7sr_ts_df)


```

##Landsat 8
```{r}
path_l8sr_ts <- "D:/Tomato_Phenology_RemoteSensing/GEE_output/Landsat8sr_ts"
l8sr_ts_names <- list.files(path_l8sr_ts, full.names = TRUE, pattern = ".csv")
l8sr_ts_names
l8sr_ts_list<- list()

read_l8sr_ts <- function(filenames){
  ts <- read.csv(filenames)
  names(ts)[4] <- "Date"
  ts <- ts[,c("Area_acre","County","Date","mean")]
  ts$Date <- as.character(ts$Date)
  ts$Date <- as.Date(sapply(strsplit(ts$Date,split = "_"),'[',3),"%Y%m%d")
  #remove NAs
  ts <- na.omit(ts)
  #if there are two values per date, average it 
  ts <- aggregate(ts$mean, by = list("Date" = ts$Date,"Area_acre" = ts$Area_acre,"County" = ts$County), FUN = mean)
  #add band name
  names(ts)[4] <- "mean"
  ts$Band <- unlist(ex_between(filenames, left = "L8_", right = "_20", extract = TRUE))
  #scale the value 
  if(unique(ts$Band) != "B10" & unique(ts$Band) != "B11"){
    ts$mean <- ts$mean * 0.0001
  }
  if(unique(ts$Band) == "B10" | unique(ts$Band) == "B11"){
    ts$mean <- ts$mean * 0.1
  }
  return(ts)
}

#Apply the function 
for(i in 1:length(l8sr_ts_names)){
  l8sr_ts_list[[i]] <- read_l8sr_ts(filenames = l8sr_ts_names[i])
}
head(l8sr_ts_list[[1]])
dim(l8sr_ts_list[[1]])

#change the list to df
l8sr_ts_df <- do.call(rbind, l8sr_ts_list)
dim(l8sr_ts_df) #7182747,5
#convert long to wide 
l8sr_ts_df <- spread(l8sr_ts_df, key = "Band",value = "mean")
head(l8sr_ts_df)


```

###Calculate vis
####Function
```{r}
ndvi_l8 <- function(df){
  red <- df$B4
  nir <- df$B5
  NDVI <- (nir-red)/(nir+red)
  return(NDVI)
}
evi_l8 <- function(df){
  red <- df$B4
  nir <- df$B5
  blue <- df$B2
  EVI <- 2.5*(nir-red)/(nir+6*red-7.5*blue+1)
  return(EVI)
}

evi2_l8 <- function(df){
  red <- df$B4
  nir <- df$B5
  EVI2 <- 2.4*(nir-red)/(nir+red+1)
  return(EVI2)
}

wdrvi_l8 <- function(df){
  nir <- df$B5
  red <- df$B4
  alpha <- 0.1
  WDRVI <- (alpha*nir - red)/(alpha*nir + red)
  return(WDRVI)
}

ndmi_l8 <- function(df){
  nir <- df$B5
  swir <- df$B6
  NDMI <- (nir-swir)/(nir+swir)
  return(NDMI)
}

addVIs_l8 <- function(df){
  df$NDVI <- ndvi_l8(df)
  df$EVI <- evi_l8(df)
  df$EVI2 <- evi2_l8(df)
  df$WDRVI <- wdrvi_l8(df)
  df$NDMI <- ndmi_l8(df)
  return(df)
}
```

####Apply the function
```{r}
l8sr_ts_df <- addVIs_l8(l8sr_ts_df)
head(l8sr_ts_df)
```

#Merge l5,l7,l8 together 
```{r}
#Add Year
l5sr_ts_df$Year <- lubridate::year(l5sr_ts_df$Date)
l7sr_ts_df$Year <- lubridate::year(l7sr_ts_df$Date)
l8sr_ts_df$Year <- lubridate::year(l8sr_ts_df$Date)
#Add sensor name
l5sr_ts_df$Sensor <- "L5"
l7sr_ts_df$Sensor <- "L7"
l8sr_ts_df$Sensor <- "L8"

unique(l5sr_ts_df$Year) #2008-2011
unique(l7sr_ts_df$Year) #2008-2019
unique(l8sr_ts_df$Year) #2013-2019

l578_ts_df <- rbind(l5sr_ts_df, l7sr_ts_df)
names(l578_ts_df)[4:10] <- c("Blue","Green","Red","NIR","SWIR1","BT","SWIR2")

l8sr_ts_df_new <- l8sr_ts_df[,c(1,2,3)]
l8sr_ts_df_new$Blue <- l8sr_ts_df$B2
l8sr_ts_df_new$Green <- l8sr_ts_df$B3
l8sr_ts_df_new$Red <- l8sr_ts_df$B4
l8sr_ts_df_new$NIR <- l8sr_ts_df$B5
l8sr_ts_df_new$SWIR1 <- l8sr_ts_df$B6
l8sr_ts_df_new$BT <- (l8sr_ts_df$B10+l8sr_ts_df$B11)/2
l8sr_ts_df_new$SWIR2 <- l8sr_ts_df$B7
l8sr_ts_df_new <- cbind(l8sr_ts_df_new, l8sr_ts_df[,c(13:18)])
l8sr_ts_df_new$Sensor <- "L8"
names(l8sr_ts_df_new)

l578_ts_df <- rbind(l578_ts_df, l8sr_ts_df_new)
```

#Have a lot at some sample fields
```{r}
sample_fields <- sample(l578_ts_df$Area_acre, 1)
sample_fields  #647208.9
ggplot(subset(l578_ts_df, Area_acre %in% sample_fields & Year < 2015 ), aes(x = Date, y = EVI, color = as.factor(Sensor))) + geom_point() 
```

#Filter out some fields that might not be tomatoes
```{r}
l578_ts_df$Month <- lubridate::month(l578_ts_df$Date)
ls_field <- split(l578_ts_df, list(l578_ts_df$Area_acre, l578_ts_df$Year))
yesno <- rep(0, length(ls_field))
for(i in 1:length(ls_field)){
  df_peak <- subset(ls_field[[i]], Month>=6 & Month <= 9)
  if(max(df_peak$NDVI, na.rm = TRUE) < 0.5){
    yesno[i] <- (-1)
  }
  if(max(df_peak$NDVI, na.rm = TRUE) >= 0.5){
    yesno[i] <- 1
  }
} 
ls_field_filt <- ls_field[which(yesno == 1)]

dim(l578_ts_df) #
length(ls_field_filt) #18630
length(ls_field) #226728
ls_field_filt2 <- ls_field[which(yesno == -1)]
l578_ts_df_filt2 <- do.call(rbind, ls_field_filt2)
l578_ts_df_filt <- do.call(rbind, ls_field_filt)
dim(l578_ts_df_filt2) #25586
dim(l578_ts_df_filt) #2247775
dim(l578_ts_df)  #2273361
#sample plots of tomato fields
sample1 <- sample(l578_ts_df_filt$Area_acre, 3)
ggplot(subset(l578_ts_df_filt, Area_acre %in% sample1), aes(x = Date, y = EVI, color = as.factor(Area_acre))) + geom_point() 
#sample plots of non-tomato fields
sample2 <- sample(l578_ts_df_filt2$Area_acre, 3)
ggplot(subset(l578_ts_df_filt2, Area_acre %in% sample2 &  Year <2016), aes(x = Date, y = EVI, color = as.factor(Area_acre))) + geom_point() + theme(legend.position = "none")
sample3 <- sample(l578_ts_df_filt2$Area_acre, 10)
ggplot(subset(l578_ts_df_filt2, Area_acre %in% sample3 &  Year <2016), aes(x = Date, y = EVI, color = as.factor(Area_acre))) + geom_point() + theme(legend.position = "none") + ylim(0,0.8)

hist(sapply(ls_field_filt, function(x){max(x$EVI)}))
summary(sapply(ls_field_filt, function(x){max(x$NDVI)}))
#filter out dates that have too high value
l578_ts_df_filt <- subset(l578_ts_df_filt, NDVI < 1)
l578_ts_df_filt <- subset(l578_ts_df_filt, EVI < 1)
dim(l578_ts_df_filt) #2246728, 18
l578_ts_df_filt <- subset(l578_ts_df_filt, Blue < 1 & Green < 1 & Red < 1 & NIR < 1 & SWIR1 < 1 & SWIR2 < 1)
summary(l578_ts_df_filt$NDVI)
lapply(l578_ts_df_filt, summary)
dim(l578_ts_df_filt) #2245898, 18

sum(is.na(l578_ts_df_filt)) #0
#remove the nas 
head(l578_ts_df)
l578_ts_df_filt$NIRv <- l578_ts_df_filt$NIR*l578_ts_df_filt$NDVI

```

#---------not useful right now---------------------------
#Merge with the field ID
```{r}

a <- split(l5sr_ts_df, l5sr_ts_df$Year)
sapply(a, function(x){length(unique(x$Area_acre))})
b <- split(l7sr_ts_df, l7sr_ts_df$Year)
sapply(b, function(x){length(unique(x$Area_acre))})
d <- split(l8sr_ts_df, l8sr_ts_df$Year)
sapply(d, function(x){length(unique(x$Area_acre))})
sapply(ls_tomato_fidbound, function(x){length(x$ID)})

l5sr_ts_df_2008 <- subset(l5sr_ts_df, Year == 2008)
l5sr_ts_df_2009 <- subset(l5sr_ts_df, Year == 2009)
l5sr_ts_df_2010 <- subset(l5sr_ts_df, Year == 2010)
l5sr_ts_df_2011 <- subset(l5sr_ts_df, Year == 2011)

l7sr_ts_df_2008 <- subset(l7sr_ts_df, Year == 2008)
l7sr_ts_df_2009 <- subset(l7sr_ts_df, Year == 2009)
l7sr_ts_df_2010 <- subset(l7sr_ts_df, Year == 2010)
l7sr_ts_df_2011 <- subset(l7sr_ts_df, Year == 2011)
l7sr_ts_df_2012 <- subset(l7sr_ts_df, Year == 2012)
l7sr_ts_df_2013 <- subset(l7sr_ts_df, Year == 2013)
l7sr_ts_df_2014 <- subset(l7sr_ts_df, Year == 2014)
l7sr_ts_df_2015 <- subset(l7sr_ts_df, Year == 2015)
l7sr_ts_df_2016 <- subset(l7sr_ts_df, Year == 2016)
l7sr_ts_df_2017 <- subset(l7sr_ts_df, Year == 2017)
l7sr_ts_df_2018 <- subset(l7sr_ts_df, Year == 2018)
l7sr_ts_df_2019 <- subset(l7sr_ts_df, Year == 2019)

l8sr_ts_df_2013 <- subset(l8sr_ts_df, Year==2013)
l8sr_ts_df_2014 <- subset(l8sr_ts_df, Year==2014)
l8sr_ts_df_2015 <- subset(l8sr_ts_df, Year==2015)
l8sr_ts_df_2016 <- subset(l8sr_ts_df, Year==2016)
l8sr_ts_df_2017 <- subset(l8sr_ts_df, Year==2017)
l8sr_ts_df_2018 <- subset(l8sr_ts_df, Year==2018)
l8sr_ts_df_2019 <- subset(l8sr_ts_df, Year==2019)

l8sr_ts_df_2013 <- merge(l8sr_ts_df_2013, tomato_fidbound_2013, by = c("Year", "Area_acre"))
l8sr_ts_df_2014 <- merge(l8sr_ts_df_2014, tomato_fidbound_2014, by = c("Year", "Area_acre"))
l8sr_ts_df_2015 <- merge(l8sr_ts_df_2015, tomato_fidbound_2015, by = c("Year", "Area_acre"))
l8sr_ts_df_2016 <- merge(l8sr_ts_df_2016, tomato_fidbound_2016, by = c("Year", "Area_acre"))
l8sr_ts_df_2017 <- merge(l8sr_ts_df_2017, tomato_fidbound_2017, by = c("Year", "Area_acre"))
l8sr_ts_df_2018 <- merge(l8sr_ts_df_2018, tomato_fidbound_2018, by = c("Year", "Area_acre"))
l8sr_ts_df_2019 <- merge(l8sr_ts_df_2019, tomato_fidbound_2019, by = c("Year", "Area_acre"))



l8sr_ts_df_2013 <- merge(l8sr_ts_df_2013, tomato_fidbound_2013, by = c("Year", "Area_acre"))
l8sr_ts_df_2014 <- merge(l8sr_ts_df_2014, tomato_fidbound_2014, by = c("Year", "Area_acre"))
l8sr_ts_df_2015 <- merge(l8sr_ts_df_2015, tomato_fidbound_2015, by = c("Year", "Area_acre"))
l8sr_ts_df_2016 <- merge(l8sr_ts_df_2016, tomato_fidbound_2016, by = c("Year", "Area_acre"))
l8sr_ts_df_2017 <- merge(l8sr_ts_df_2017, tomato_fidbound_2017, by = c("Year", "Area_acre"))
l8sr_ts_df_2018 <- merge(l8sr_ts_df_2018, tomato_fidbound_2018, by = c("Year", "Area_acre"))
l8sr_ts_df_2019 <- merge(l8sr_ts_df_2019, tomato_fidbound_2019, by = c("Year", "Area_acre"))

```
#---------not useful right now---------------------------
#
#Monthly Average for each band for county 
```{r}

l578_county_month <- aggregate(subset(l578_ts_df_filt, Month %in% c(3:10))[,c("Blue","Green","Red","NIR","SWIR1","BT","SWIR2","NDVI","EVI","EVI2","WDRVI","NDMI","NIRv")], by = list("Year" = subset(l578_ts_df_filt, Month %in% c(3:10))$Year, "County" = subset(l578_ts_df_filt, Month %in% c(3:10))$County, "Month" = subset(l578_ts_df_filt, Month %in% c(3:10))$Month),FUN = mean)
#check if there's any nas 
sum(is.na(l578_county_month)) #0
dim(l578_county_month)  #1940,16
head(l578_county_month)


```
##Weighted Average based on Area
```{r}
#calculate area ratio 
ls_temp <- l578_ts_df_filt %>% group_by(Area_acre, Year) %>% summarise("Area_acre"= unique(Area_acre), "County" = unique(County))
l578_county_area <- aggregate(ls_temp[,"Area_acre"], by = list("County" = ls_temp$County, "Year" = ls_temp$Year), FUN = sum)
l578_county_area$Area_acre <- l578_county_area$Area_acre/4046.8564224
l578_county_area <- merge(l578_county_area, yield_2008_2019, by = c("County","Year"))
names(l578_county_area)[c(3,6)] <- c("Area_NASS","Area_Report")
ggplot(l578_county_area, aes(x = Area_NASS, y = Area_Report)) + geom_point(aes(color = County)) + geom_abline(slope = 1, intercept = 0) + theme_bw() + geom_smooth(method = "lm", se = FALSE)
ggplot(subset(l578_county_area, County != "Fresno"), aes(x = Area_NASS, y = Area_Report)) + geom_point(aes(color = as.factor(Year))) + geom_abline(slope = 1, intercept = 0) + theme_bw() + geom_smooth(method = "lm", se = FALSE)

cor(l578_county_area$Area_Report, l578_county_area$Area_NASS)^2  #0.872
cor(subset(l578_county_area, County!= "Fresno")$Area_Report, subset(l578_county_area, County!= "Fresno")$Area_NASS)^2  #0.673

l578_county_monthweighted <- merge(l578_county_area, l578_ts_df_filt, by = c("Year", "County"))
#add ratio column 
l578_county_monthweighted$Area_ratio <- l578_county_monthweighted$Area_acre/4046.8564224/l578_county_monthweighted$Area_NASS
summary(l578_county_monthweighted$Area_ratio)
#calculate weighted average
l578_county_monthweighted <- subset(l578_county_monthweighted, Month %in% c(3:10)) %>% group_by(County, Year, Month) %>% summarise("Blue" = weighted.mean(Blue, Area_ratio), "Green" = weighted.mean(Green, Area_ratio), "Red" = weighted.mean(Red, Area_ratio), "NIR" = weighted.mean(NIR, Area_ratio), "SWIR1" = weighted.mean(SWIR1, Area_ratio), "SWIR2" = weighted.mean(SWIR2, Area_ratio), "NDVI" = weighted.mean(NDVI, Area_ratio), "EVI" = weighted.mean(EVI, Area_ratio), "EVI2" = weighted.mean(EVI2, Area_ratio), "WDRVI" = weighted.mean(WDRVI, Area_ratio), "NDMI" = weighted.mean(NDMI, Area_ratio), "NIRv" = weighted.mean(NIRv, Area_ratio))
dim(l578_county_monthweighted) #1293, 15
#combine with yield
l578_county_monthweighted_yield <- merge(l578_county_monthweighted, yield_2008_2019, by = c("Year","County"))
dim(l578_county_monthweighted_yield) #1293, 18 
#convert long to wide/
l578_county_monthweighted_yield <- tidyr::pivot_wider(data = l578_county_monthweighted_yield, names_from =  Month, values_from = Blue:NIRv)
dim(l578_county_monthweighted_yield) #162, 101

#remove outliers
l578_county_monthweighted_yield_filt1 <- na.omit(l578_county_monthweighted_yield)
l578_county_monthweighted_yield_filt1 <- subset(l578_county_monthweighted_yield_filt1, County != "Santa Clara")
l578_county_monthweighted_yield_filt1 <- subset(l578_county_monthweighted_yield_filt1, Yield < 65)
dim(l578_county_monthweighted_yield_filt1) #149,101
sum(is.na(l578_county_monthweighted_yield_filt1)) #0
sum(is.na(l578_county_monthweighted_yield))  #36



```

#Combine with Yield Data
```{r}

l578_county_monthweighted_yield <- merge(l578_county_monthweighted, yield_county, by = c("Year","County"))
names(l578_county_monthweighted_yield)


dim(l578_county_monthweighted_yield) #1117, 23
sum(is.na(l578_county_monthweighted_yield)) #0
#convert long to wide
l578_county_monthweighted_yield <- tidyr::pivot_wider(data = l578_county_monthweighted_yield, names_from =  Month, values_from = Blue:NIRv)

dim(l578_county_monthweighted_yield) #140,106
sum(is.na(l578_county_monthweighted_yield))  #36
apply(l578_county_monthweighted_yield, 2, function(x) any(is.na(x)))
#l578_county_monthweighted_yield %>% select_if(~!any(is.na(.))) 
l578_county_monthweighted_yield_filt1 <- na.omit(l578_county_monthweighted_yield)
dim(l578_county_monthweighted_yield_filt1) #137,106


#merge with yield 
l578_county_month_yield <- merge(l578_county_month, yield_county, by = c("Year","County"))
head(l578_county_month_yield)
dim(l578_county_month_yield) #1117, 24
sum(is.na(l578_county_month_yield)) #0
#convert to wide
l578_county_month_yield <- tidyr::pivot_wider(data = l578_county_month_yield, names_from =  Month, values_from = Blue:NIRv)
dim(l578_county_month_yield) #140, 114
sum(is.na(l578_county_month_yield)) #39
l578_county_month_yield <- na.omit(l578_county_month_yield)
dim(l578_county_month_yield) #137,114


##If there's a trned
lmtrend <- lm(l578_county_month_yield$Yield ~ l578_county_month_yield$Year)
summary(lmtrend)  #p < 0.006, r2 = 0.0456

#Combine with latitude, longitude
l578_county_month_yield <- merge(l578_county_month_yield, CA_counties@data[,c("NAME","INTPTLAT","INTPTLON")], by.x = "County", by.y = "NAME")
dim(l578_county_month_yield)#162,98
names(l578_county_month_yield)[110:111] <- c("Latitude","Longitude")


#Area
class(l578_county_month_yield$County)


#remove the outlier 

sum(l578_county_month_yield$Yield>60, na.rm = TRUE) #2
sum(l578_county_month_yield_filt1$Yield>60, na.rm = TRUE) #3
max(l578_county_month_yield$Yield)

ggplot(l578_county_month_yield, aes(x = Year, y = Yield)) + geom_point(aes(color = County)) + theme_bw() + geom_smooth(method = "lm") 

```
##Exploratory analysis
```{r}
#l578_county_month_yield <- na.omit(l578_county_month_yield)


cor_vis1 <- cor(x = l578_county_month_yield[,11:114], y = l578_county_month_yield[,c(4,6,7,9,10)], use = "complete.obs")
View(cor_vis1)
#l578_county_month_yield 

cor_vis2 <- cor(x = l578_county_monthweighted_yield[,11:106], y = l578_county_monthweighted_yield[,c(4,6,7,9,10)], use = "complete.obs")
View(cor_vis2)
#cor_vis2 <- data.frame("var" = names(l578_county_monthweighted_yield)[11:101], "r" = cor_vis2)


ggplot(l578_county_month_yield, aes(x = NIRv_6, y = Yield)) + geom_point(aes(color = County)) + theme_bw() + geom_smooth(method = "lm") + ylab("Yield (tons/acre)")
lm1 <- lm(Yield~NIRv_6, l578_county_month_yield)
summary(lm1)

ggplot(l578_county_month_yield, aes(x = NDVI_8, y = Yield)) + geom_point(aes(color = County)) + theme_bw() + geom_smooth(method = "lm") + ylab("Yield (tons/acre)")
lm2 <- lm(Yield~NDVI_8, l578_county_month_yield)
summary(lm2)


p1 = ggscatter(l578_county_monthweighted_yield, x = "NIRv_6", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")
p2 = ggscatter(l578_county_monthweighted_yield, x = "NDVI_8", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")
grid.arrange(p1,p2, nrow = 2)


```

#Read Weather data
###Monthly data from Daymet 
```{r}
path_daymet <- "D:/Tomato_Phenology_RemoteSensing/GEE_output/Daymet"
list.files(path_daymet)
maxtemp_county <- read.csv(file.path(path_daymet, "CA_county_maxtemp_2.csv"))
mintemp_county <- read.csv(file.path(path_daymet, "CA_county_mintemp_2.csv"))
#subset
maxtemp_county <- maxtemp_county[,c(4:6)]
mintemp_county <- mintemp_county[,c(4:6)]
dim(maxtemp_county)  #20880, 3
dim(mintemp_county) #20880, 3
names(maxtemp_county) <- c("County","MaxTemp","Time")
names(mintemp_county) <- c("County","MinTemp","Time")
identical(maxtemp_county$County, mintemp_county$County)
identical(maxtemp_county$Time, mintemp_county$Time)
#merge 
daymet_county <- merge(maxtemp_county, mintemp_county, by = c("County","Time"))
dim(daymet_county) #20880,4
#change Time column
daymet_county$Time <- strptime(as.character(daymet_county$Time), format = "%Y-%m-%d")
#add year and month
daymet_county$Year <- year(daymet_county$Time)
daymet_county$Month <- month(daymet_county$Time)
dim(daymet_county) #20880,5
#remove time 
daymet_county$Time <- NULL
#long  to wide
daymet_county_wide <- tidyr::pivot_wider(daymet_county, names_from = Month, values_from = MaxTemp:MinTemp)
daymet_county_wide
dim(daymet_county_wide)  #1740,26
names(daymet_county_wide)



```
##Daily data from DayMet
```{r}
#Daily data
##Read data
maxtemp_daily <- read.csv(file.path(path_daymet, "daily_maxtemp.csv"))
mintemp_daily <- read.csv(file.path(path_daymet, "daily_mintemp.csv"))
prcp_daily <- read.csv(file.path(path_daymet, "daily_prcp.csv"))
srad_daily <- read.csv(file.path(path_daymet, "daily_srad.csv"))

##Clean data
###solar radiation 
srad_daily$.geo <- NULL
srad_daily$system.time_start <- NULL
names(srad_daily) <- c("Date","Latitude","Longitude","County","srad")
srad_daily$Date <- strptime(substr(as.character(srad_daily$Date),start = 1, stop = 8), format = "%Y%m%d")
#add year and month 
srad_daily$Year <- lubridate::year(srad_daily$Date)
srad_daily$Month <- month(srad_daily$Date)

###maximum temperature 
head(maxtemp_daily)
head(prcp_daily)
maxtemp_daily$.geo<- NULL
maxtemp_daily$system.time_start <- NULL
names(maxtemp_daily) <- c("Date","Latitude","Longitude","County","MaxTemp")
maxtemp_daily$Date <- strptime(substr(as.character(maxtemp_daily$Date),start = 1, stop = 8), format = "%Y%m%d")
#add year and month 
maxtemp_daily$Year <- lubridate::year(maxtemp_daily$Date)
maxtemp_daily$Month <- month(maxtemp_daily$Date)

###minimum temperature 
mintemp_daily$.geo<- NULL
mintemp_daily$system.time_start <- NULL
names(mintemp_daily) <- c("Date","Latitude","Longitude","County","MinTemp")
mintemp_daily$Date <- strptime(substr(as.character(mintemp_daily$Date),start = 1, stop = 8), format = "%Y%m%d")
#add year and month 
mintemp_daily$Year <- lubridate::year(mintemp_daily$Date)
mintemp_daily$Month <- month(mintemp_daily$Date)

###rainfall 
prcp_daily$.geo<- NULL
prcp_daily$system.time_start <- NULL
names(prcp_daily) <- c("Date","Latitude","Longitude","County","prcp")
prcp_daily$Date <- strptime(substr(as.character(prcp_daily$Date),start = 1, stop = 8), format = "%Y%m%d")
#add year and month 
prcp_daily$Year <- lubridate::year(prcp_daily$Date)
prcp_daily$Month <- month(prcp_daily$Date)

#subset
maxtemp_daily <- subset(maxtemp_daily, Year >= 2008)
mintemp_daily <- subset(mintemp_daily, Year >= 2008)
prcp_daily <- subset(prcp_daily, Year >= 2008)
srad_daily <- subset(srad_daily, Year >= 2008)

```

###Calculate extreme weather
```{r}
##Monthly average of the 10 years
extreme_tmax <- stats::aggregate(maxtemp_daily[,"MaxTemp"], by = list("County" = maxtemp_daily$County,"Month"=maxtemp_daily$Month), FUN = function(x){quantile(x, probs = 0.9)})
names(extreme_tmax)[3] <- "thresh"
maxtemp_daily <- merge(maxtemp_daily, extreme_tmax, by = c("County","Month"))
head(maxtemp_daily)
extreme_tmax <- maxtemp_daily %>% group_by(Month, County, Year) %>% summarise(ext_hot = sum(MaxTemp>thresh))


extreme_tmin <- stats::aggregate(mintemp_daily[,"MinTemp"], by = list("County" = mintemp_daily$County,"Month"=mintemp_daily$Month), FUN = function(x){quantile(x, probs = 0.1)})
names(extreme_tmin)[3] <- "thresh"
mintemp_daily <- merge(mintemp_daily, extreme_tmin, by = c("County","Month"))
head(mintemp_daily)
extreme_tmin <- mintemp_daily %>% group_by(Month, County, Year) %>% summarise(ext_cold = sum(MinTemp<thresh))

#frost days
extreme_frost <- mintemp_daily %>% group_by(Month, County, Year) %>% summarise(frost= sum(MinTemp < 0)) 
extreme_frost
extreme_tmin

extreme_county <- merge(extreme_tmax, extreme_tmin, by = c("County","Year","Month"))
extreme_county <- merge(extreme_county, extreme_frost, by = c("County","Year","Month"))
head(extreme_county)
dim(extreme_county)

extreme_county_wide <- tidyr::pivot_wider(extreme_county, names_from = Month, values_from = ext_hot:frost)
head(extreme_county_wide)
sum(is.na(extreme_county_wide))  #0
#late rainfall 

#ggplot(extreme_tmin, aes(x = Year, y = ext_cold)) + geom_point()

```

##Read weather data from Gridmet
```{r}
path_gridmet = "D:/Tomato_Phenology_RemoteSensing/GEE_output/Gridmet"
list.files(path_gridmet)
vpd_county <- read.csv(file.path(path_gridmet, "CA_countymean_vpd.csv"))
prcp_county <- read.csv(file.path(path_gridmet, "CA_county_prcp.csv"))
eto_county <- read.csv(file.path(path_gridmet, "CA_countymean_eto.csv"))
etr_county <- read.csv(file.path(path_gridmet, "CA_countymean_etr.csv"))
srad_county <- read.csv(file.path(path_gridmet, "CA_county_srad.csv"))
vs_county <- read.csv(file.path(path_gridmet, "CA_countymean_vs.csv"))

#data cleaning
vpd_county$.geo <- NULL
vpd_county$system.index <- NULL
names(vpd_county) <- c("Latitude","Longitude","County","vpd","Date")
vpd_county$Date <- strptime(as.character(vpd_county$Date), format = "%Y-%m-%d")
prcp_county$.geo <- NULL
prcp_county$system.index <- NULL
names(prcp_county) <- c("Latitude","Longitude","County","prcp","Date")
prcp_county$Date <- strptime(as.character(prcp_county$Date), format = "%Y-%m-%d")
eto_county$.geo <- NULL
eto_county$system.index <- NULL
names(eto_county) <- c("Latitude","Longitude","County","eto","Date")
eto_county$Date <- strptime(as.character(eto_county$Date), format = "%Y-%m-%d")
etr_county$.geo <- NULL
etr_county$system.index <- NULL
names(etr_county) <- c("Latitude","Longitude","County","etr","Date")
etr_county$Date <- strptime(as.character(etr_county$Date), format = "%Y-%m-%d")
srad_county$.geo <- NULL
srad_county$system.index <- NULL
names(srad_county) <- c("Latitude","Longitude","County","srad","Date")
srad_county$Date <- strptime(as.character(srad_county$Date), format = "%Y-%m-%d")
vs_county$.geo <- NULL
vs_county$system.index <- NULL
names(vs_county) <- c("Latitude","Longitude","County","vs","Date")
vs_county$Date <- strptime(as.character(vs_county$Date), format = "%Y-%m-%d")

gridmet_county <- merge(vpd_county, prcp_county, by = c("County","Date","Latitude","Longitude"))
gridmet_county <- merge(gridmet_county, eto_county, by = c("County","Date","Latitude","Longitude"))
gridmet_county <- merge(gridmet_county, etr_county, by = c("County", "Date","Latitude","Longitude"))
gridmet_county <- merge(gridmet_county, srad_county, by = c("County", "Date","Latitude","Longitude"))
gridmet_county <- merge(gridmet_county, vs_county, by = c("County", "Date","Latitude","Longitude"))
dim(gridmet_county)
dim(vs_county)
gridmet_county$Year <- year(gridmet_county$Date)
gridmet_county$Month <- month(gridmet_county$Date)
gridmet_county$Date <- NULL
#long to wide
gridmet_county_wide <- tidyr::pivot_wider(gridmet_county, names_from = Month, values_from = vpd:vs)
names(gridmet_county_wide)
dim(gridmet_county_wide) #1740, 76

```
##Calculate cumulative weather data
####GDD
```{r}
names(maxtemp_daily)
names(mintemp_daily)
dim(maxtemp_daily)#253982, 8
dim(mintemp_daily)#253982, 8 

?pollen:gdd


temp_daily <- merge(maxtemp_daily, mintemp_daily, by = c("County","Date","Year","Month","Latitude","Longitude"))
temp_daily$thresh.x <- NULL
temp_daily$thresh.y <- NULL
head(temp_daily)
names(temp_daily)
dim(temp_daily) #253982, 8

gdd_daily <- temp_daily %>% group_by(County, Year) %>% summarise("Date" = Date,"MaxTemp" = MaxTemp, "MinTemp" = MinTemp,"GDD" = pollen::gdd(tmax = MaxTemp, tmin = MinTemp, tbase = 10, tbase_max = 30, type = "C")) 
#it's already cumulated GDD
head(gdd_daily)
dim(gdd_daily)  #253982, 6


```
####Cumulated Radiation 
```{r}
srad_daily_cum <- srad_daily %>% group_by(County, Year) %>% summarise("cumsrad" = cumsum(srad))

srad_daily_cum
```
####Long-term seasonal Temperature
```{r}
head(temp_daily)
temp_longterm <- temp_daily %>% dplyr::filter(Month >= 3, Month <= 9) %>% group_by(County, Latitude, Longitude) %>% summarise("MaxTemp_ltm" = mean(MaxTemp),"MinTemp_ltm" = mean(MinTemp))
head(temp_longterm)
temp_longterm$MeanTemp_ltm <- (temp_longterm$MaxTemp_ltm + temp_longterm$MinTemp_ltm)/2

ggplot(temp_longterm, aes(x = Latitude, y = MaxTemp_ltm)) + geom_point(aes(color = County)) + geom_smooth(method = "lm")
ggplot(temp_longterm, aes(x = Latitude, y = MinTemp_ltm)) + geom_point(aes(color = County)) + geom_smooth(method = "lm")
ggplot(temp_longterm, aes(x = Latitude, y = MeanTemp_ltm)) + geom_point(aes(color = County)) + geom_smooth(method = "lm") 

cor(temp_longterm$Latitude, temp_longterm$MaxTemp_ltm)^2 #0.2524
cor(temp_longterm$Latitude, temp_longterm$MinTemp_ltm)^2 #0.3809
cor(temp_longterm$Latitude, temp_longterm$MeanTemp_ltm)^2 #0.3271


#subset with only the tomato counties
head(weather_county_wide)
unique(weather_county_wide$County)
```
####Long-term seasonal radiation 
```{r}
unique(l578_county_monthweighted_yield_weather$County)
list_county <- unique(l578_county_monthweighted_yield_weather$County)

head(srad_daily)
srad_longterm <- srad_daily  %>% group_by(County, Latitude, Longitude) %>% summarise("srad_ltm" = sum(srad))
srad_longterm <- srad_daily  %>% dplyr::filter(Month >= 10 , Month <= 12)%>% group_by(County, Latitude, Longitude) %>% summarise("srad_ltm" = sum(srad))
cor(srad_longterm$Latitude, srad_longterm$srad_ltm)^2 #0.798
cor(subset(srad_longterm, County %in% list_county)$Latitude, subset(srad_longterm, County %in% list_county)$srad_ltm)^2 #0.895

ggscatter(srad_longterm, x = "Latitude", y = "srad_ltm", add = "reg.line") + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Long-term Solar Radiation (W/m2)")
ggscatter(subset(srad_longterm, County %in% list_county), x = "Latitude", y = "srad_ltm", add = "reg.line") + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Long-term Solar Radiation (W/m2)")



temp_longterm <- temp_daily %>% dplyr::filter(Month >= 1, Month <=12) %>% group_by(County, Latitude, Longitude) %>% summarise("MaxTemp_ltm" = mean(MaxTemp),"MinTemp_ltm" = mean(MinTemp))
temp_longterm$MeanTemp_ltm <- (temp_longterm$MaxTemp_ltm + temp_longterm$MinTemp_ltm)/2
cor(temp_longterm$Latitude, temp_longterm$MaxTemp_ltm)^2 #0.2524
cor(temp_longterm$Latitude, temp_longterm$MinTemp_ltm)^2 #0.3809
cor(temp_longterm$Latitude, temp_longterm$MeanTemp_ltm)^2 #0.3271
cor(subset(temp_longterm, County %in% list_county)$Latitude, subset(temp_longterm, County %in% list_county)$MaxTemp_ltm)^2 #0.2524
cor(subset(temp_longterm, County %in% list_county)$Latitude, subset(temp_longterm, County %in% list_county)$MinTemp_ltm)^2 #0.2524
cor(subset(temp_longterm, County %in% list_county)$Latitude, subset(temp_longterm, County %in% list_county)$MeanTemp_ltm)^2 #0.2524



```

##Combine all weather data
```{r}
weather_county_wide <- merge(daymet_county_wide, extreme_county_wide, by = c("County","Year"))
weather_county_wide <- merge(weather_county_wide, gridmet_county_wide, by = c("County","Year"))
weather_county_wide <- base::merge(weather_county_wide, temp_longterm, by = c("County","Latitude","Longitude"))
names(weather_county_wide)

```
##Check if it matches the annual report
```{r}
#Cold time in the spring 
names(extreme_county)
ggplot(subset(extreme_county, Year >= 2008 & Month <6 & Month > 2), aes(x = as.factor(Month), y = ext_cold, fill = as.factor(Year))) + geom_boxplot() + xlab("Month") + ylab("Extreme Cold Days") + theme_bw()+ theme(legend.title = element_blank()) 
names(daymet_county)
ggplot(subset(daymet_county, Year >= 2008 & Month < 6 & Month > 2), aes(x = as.factor(Month), y = MinTemp, fill = as.factor(Year))) + geom_boxplot() + xlab("Month") + ylab("Minimum Temperature") + theme_bw()+ theme(legend.title = element_blank()) 

names(gridmet_county)
ggplot(subset)

#frost in the spring 
ggplot(subset(extreme_county, Year >= 2008 & Month <6 & Month >= 2), aes(x = as.factor(Month), y = frost, fill = as.factor(Year))) + geom_boxplot() + xlab("Month") + ylab("Frost Days") + theme_bw()+ theme(legend.title = element_blank()) 


#Hot time in the summer 
ggplot(subset(extreme_county, Year >= 2008 & Month <9 & Month > 4), aes(x = as.factor(Month), y = ext_hot, fill = as.factor(Year))) + geom_boxplot() + xlab("Month") + ylab("Extreme hot Days") + theme_bw()+ theme(legend.title = element_blank()) 
ggplot(subset(daymet_county, Year >= 2008 & Month < 9 & Month > 4), aes(x = as.factor(Month), y = MaxTemp, fill = as.factor(Year))) + geom_boxplot() + xlab("Month") + ylab("Maximum Temperature") + theme_bw()+ theme(legend.title = element_blank()) 



#rainfall
ggplot(subset(gridmet_county, Year >= 2008 & Month < 5 & Month > 1), aes(x = as.factor(Month), y = prcp, fill = as.factor(Year))) + geom_boxplot() + xlab("Month") + ylab("PRCP") + theme_bw()+ theme(legend.title = element_blank()) 

#VPD
ggplot(subset(gridmet_county, Year >= 2008 & Month < 9 & Month >= 4), aes(x = as.factor(Month), y = vpd, fill = as.factor(Year))) + geom_boxplot() + xlab("Month") + ylab("VPD") + theme_bw()+ theme(legend.title = element_blank()) 

#eto 
ggplot(subset(gridmet_county, Year >= 2008 & Month < 9 & Month > 2), aes(x = as.factor(Month), y = eto, fill = as.factor(Year))) + geom_boxplot() + xlab("Month") + ylab("ETO") + theme_bw()+ theme(legend.title = element_blank()) 

#etr 
ggplot(subset(gridmet_county, Year >= 2008 & Month < 9 & Month > 2), aes(x = as.factor(Month), y = etr, fill = as.factor(Year))) + geom_boxplot() + xlab("Month") + ylab("ETR") + theme_bw()+ theme(legend.title = element_blank()) 

#radiation 
ggplot(subset(gridmet_county, Year >= 2008 & Month < 9 & Month > 2), aes(x = as.factor(Month), y = srad, fill = as.factor(Year))) + geom_boxplot() + xlab("Month") + ylab("Solar Radiation") + theme_bw()+ theme(legend.title = element_blank()) 


``` 
##Exploratory analysis
```{r}
#Weighted average
l578_county_monthweighted_yield_weather <- merge(l578_county_monthweighted_yield, weather_county_wide, by = c("County","Year"))
names(l578_county_monthweighted_yield_weather)
dim(l578_county_monthweighted_yield_weather) #140,231
sum(is.na(l578_county_monthweighted_yield_weather)) #0
sum(is.na(l578_county_monthweighted_yield))  #0
#remove the columns that contain NAs
l578_county_monthweighted_yield_weather <- l578_county_monthweighted_yield_weather[, colSums(is.na(l578_county_monthweighted_yield_weather))==0]
dim(l578_county_monthweighted_yield_weather)  #140, 228
#remove the columns that are all zero
l578_county_monthweighted_yield_weather <- l578_county_monthweighted_yield_weather[,colSums(l578_county_monthweighted_yield_weather!=0)>0]
dim(l578_county_monthweighted_yield_weather)

cor_vis4 <- cor(x = l578_county_monthweighted_yield_weather[,95:224], y = l578_county_monthweighted_yield[,c(4,6,7,8,9,10)], use = "complete.obs")
View(cor_vis4)

lm1 <- lm(Yield~ext_cold_3, l578_county_monthweighted_yield_weather)
summary(lm1)


ggscatter(l578_county_monthweighted_yield_weather, x = "vs_7", y = "Yield", add = "reg.line") + theme_bw() + ylab("Yield (tons/acre)")+ stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~")))

ggscatter(l578_county_monthweighted_yield_weather, x = "srad_7", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

#ggscatter(l578_county_monthweighted_yield_weather, x = "ext_cold_3", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

ggscatter(l578_county_monthweighted_yield_weather, x = "Latitude", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")
ggscatter(l578_county_monthweighted_yield_weather, x = "MinTemp_ltm", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")
ggscatter(l578_county_monthweighted_yield_weather, x = "MaxTemp_ltm", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")
ggscatter(l578_county_monthweighted_yield_weather, x = "MeanTemp_ltm", y = "Yield", add = "reg.line", color = "County") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")



ggscatter(l578_county_monthweighted_yield_weather, x = "ext_cold_4", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

ggscatter(l578_county_monthweighted_yield_weather, x = "vs_8", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

ggscatter(l578_county_monthweighted_yield_weather, x = "srad_6", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

ggscatter(l578_county_monthweighted_yield_weather, x = "srad_7", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

ggscatter(l578_county_monthweighted_yield_weather, x = "srad_6", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

ggscatter(l578_county_monthweighted_yield_weather, x = "srad_5", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

ggscatter(l578_county_monthweighted_yield_weather, x = "vpd_7", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")


ggscatter(l578_county_monthweighted_yield_weather, x = "MinTemp_7", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

ggscatter(l578_county_monthweighted_yield_weather, x = "ext", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")


#ggscatter(l578_county_monthweighted_yield_weather, x = "ext_hot_9", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

#ggscatter(l578_county_monthweighted_yield_weather, x = "ext_hot_8", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")
ggscatter(l578_county_monthweighted_yield_weather, x = "ext_hot_10", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

```



#Extract phenology for each field
```{r}
l578_ts_df$NIRv <- l578_ts_df$NIR * l578_ts_df$NDVI
l578_ts_df_filt1 <- subset(l578_ts_df, Blue < 1 & Green < 1 & Red < 1 & NIR < 1 & SWIR1 < 1 & SWIR2 < 1 & NDVI < 1 & EVI<1 & NIRv < 1 & WDRVI < 1 & NIRv < 1 & NDMI < 1)
l578_ts_df_filt1 <- l578_ts_df_filt1 %>% mutate(Year_Field = paste(Year, Area_acre, sep = "_"))

#split as lists
ls_field_filt1 <- split(l578_ts_df_filt1, l578_ts_df_filt1$Year_Field)

yesno <- rep(0, length(ls_field_filt1))


field_pheno <- data.frame("ID" = names(ls_field_filt1), "Year" = 0, "UD_T"=0,"UD_V"=0, "SD_T"=0,"SD_V"=0, "DD_T"=0,"DD_V"=0,"RD_T" = 0, "RD_V" = 0, "max_T" = 0, "max_V"=0, "LengthGS"=0)
for(i in 215567:length(ls_field_filt1)){
  if(nrow(ls_field_filt1[[i]])==0){
    yesno[i] <- (-1)
  } 
  if(nrow(ls_field_filt1[[i]])!=0){
    field_pheno$ID[i] <- ls_field_filt1[[i]]$Area_acre
    field_pheno$Year[i] <- ls_field_filt1[[i]]$Year
    df <- ls_field_filt1[[i]]
    df <- df[order(df$Date),]
    DOY <- as.numeric(strftime(df$Date, format = "%j"))
    EVI_filt <- sgolayfilt(df$EVI)
    EVI_DOY <- cbind(1:365, NA)
    EVI_DOY[DOY,2] <- EVI_filt 
    EVI_smooth <- na_interpolation(x = EVI_DOY, option = "linear")
    curve_fit <- curvefit(y = EVI_smooth[,2], t = EVI_smooth[,1], tout = 1:365, methods = "Gu")
    pheno_stage <- get_pheno.fFITs(curve_fit, method = "Gu")
    fitted_value <- curve_fit$fFIT$Gu$zs$iter2
    #Extract useful information 
    ##Upturn date
    if(sum(is.na(pheno_stage$GU))==0){
      field_pheno$UD_T[i] <- pheno_stage$GU[1]
      field_pheno$UD_V[i] <- fitted_value[pheno_stage$GU[1]]
      ##stabilization date
      field_pheno$SD_T[i] <- pheno_stage$GU[2]
      field_pheno$SD_V[i] <- fitted_value[pheno_stage$GU[2]]
      ##downturn date
      field_pheno$DD_T[i] <- pheno_stage$GU[3]
      field_pheno$DD_V[i] <- fitted_value[pheno_stage$GU[3]]
      ##recession date 
      field_pheno$RD_T[i] <- pheno_stage$GU[4]
      field_pheno$RD_V[i] <- fitted_value[pheno_stage$GU[4]]
      #maximum value 
      field_pheno$max_T[i] <- pheno_stage$GU[2]+which.max(fitted_value[pheno_stage$GU[2]:pheno_stage$GU[3]])-1
      field_pheno$max_V[i] <- max(fitted_value[pheno_stage$GU[2]:pheno_stage$GU[3]])
      #length of gs 
      field_pheno$LengthGS[i] <- field_pheno$RD_T[i] - field_pheno$UD_T[i]
    }
    else{
      field_pheno[i,] <- NA
    }
  }
}
a <- field_pheno[which(yesno!=-1),]
head(a)
a <- na.omit(a)
head(a)
dim(a)  #47150
sum(yesno==-1) #176987

field_pheno_filt <- field_pheno[which(yesno!=-1),]
dim(field_pheno_filt)  #49741, 13
dim(field_pheno)  #226728, 13
sum(is.na(field_pheno_filt)) #33683
summary(field_pheno_filt)
field_pheno_filt <- na.omit(field_pheno_filt)
dim(field_pheno_filt)  #47150, 13
field_pheno_filt <- subset(field_pheno_filt, max_T > 60)
ggplot(field_pheno_filt, aes(x = max_T, y = max_V)) + geom_point()


```
##Aggregate to county-level
```{r}
field_pheno_filt
```

#Calculate peak
```{r}

head(l578_ts_df_filt1)
dim(l578_ts_df_filt1)  #2271453, 18

ls_field_filt2 <- split(l578_ts_df_filt1, l578_ts_df_filt1$Year_Field)
length(ls_field_filt2) #49741
ls_field_filt2[[1]]

ls_field_filt2_smooth <- list()
field_peak <- data.frame("ID" = names(ls_field_filt2), "Year" = 0,"Area_acre" = 0,"County" = 0, "peakT_EVI" = 0, "peakV_EVI"=0, "peakT_NDVI" = 0, "peakV_NDVI" = 0, "peakT_EVI2" = 0, "peakV_EVI2" = 0, "peakT_WDRVI" = 0, "peakV_WDRVI" = 0, "peakT_NDMI" = 0, "peakV_NDMI" = 0, "peakT_NIRv" = 0, "peakV_NIRv" = 0)
field_peak$Year <- sapply(strsplit(field_peak$ID, split = "_"),'[',1)
field_peak$Area_acre <- sapply(strsplit(field_peak$ID, split = "_"),'[',2)


for(i in 1:length(ls_field_filt2)){
  df <- ls_field_filt2[[i]]
  DOY <- as.numeric(strftime(df$Date, format = "%j"))
  field_peak$County[i] <- unique(df$County)
  #EVI
  EVI_filt <- sgolayfilt(df$EVI)
  EVI_DOY <- cbind(1:365, NA)
  EVI_DOY[DOY, 2] <- EVI_filt
  EVI_smooth <- na_interpolation(x = EVI_DOY, option = "linear")
  ls_field_filt2_smooth[[i]] <- data.frame("DOY"=EVI_smooth[,1], "EVI" = EVI_smooth[,2])
  ls_field_filt2_smooth[[i]]$Area_acre <- unique(df$Area_acre)
  ls_field_filt2_smooth[[i]]$Year <- unique(df$Year)
  ls_field_filt2_smooth[[i]]$County <- unique(df$County)
  ##find peaks during June-Sept
  EVI_smooth_peak <- subset(ls_field_filt2_smooth[[i]], DOY> 150 & DOY < 273)
  field_peak$peakV_EVI[i] <- max(EVI_smooth_peak$EVI)
  field_peak$peakT_EVI[i] <- which.max(EVI_smooth_peak$EVI)+150 
  #NDVI
  NDVI_filt <- sgolayfilt(df$NDVI)
  NDVI_DOY <- cbind(1:365, NA)
  NDVI_DOY[DOY, 2] <- NDVI_filt
  NDVI_smooth <- na_interpolation(x = NDVI_DOY, option = "linear")
  ls_field_filt2_smooth[[i]]$NDVI <- NDVI_smooth[,2]
  NDVI_smooth_peak <- subset(ls_field_filt2_smooth[[i]], DOY > 150 & DOY < 273)
  field_peak$peakV_NDVI[i] <- max(NDVI_smooth_peak$NDVI)
  field_peak$peakT_NDVI[i] <- which.max(NDVI_smooth_peak$NDVI)+150
  #EVI2
  EVI2_filt <- sgolayfilt(df$EVI2)
  EVI2_DOY <- cbind(1:365, NA)
  EVI2_DOY[DOY, 2] <- EVI2_filt
  EVI2_smooth <- na_interpolation(x = EVI2_DOY, option = "linear")
  ls_field_filt2_smooth[[i]]$EVI2 <- EVI2_smooth[,2]
  EVI2_smooth_peak <- subset(ls_field_filt2_smooth[[i]], DOY > 150 & DOY < 273)
  field_peak$peakV_EVI2[i] <- max(EVI2_smooth_peak$EVI2)
  field_peak$peakT_EVI2[i] <- which.max(EVI2_smooth_peak$EVI2)+150
  #WDRVI
  WDRVI_filt <- sgolayfilt(df$WDRVI)
  WDRVI_DOY <- cbind(1:365, NA)
  WDRVI_DOY[DOY, 2] <- WDRVI_filt
  WDRVI_smooth <- na_interpolation(x = WDRVI_DOY, option = "linear")
  ls_field_filt2_smooth[[i]]$WDRVI <- WDRVI_smooth[,2]
  WDRVI_smooth_peak <- subset(ls_field_filt2_smooth[[i]], DOY > 150 & DOY < 273)
  field_peak$peakV_WDRVI[i] <- max(WDRVI_smooth_peak$WDRVI)
  field_peak$peakT_WDRVI[i] <- which.max(WDRVI_smooth_peak$WDRVI)+150
  #NDMI
  NDMI_filt <- sgolayfilt(df$NDMI)
  NDMI_DOY <- cbind(1:365, NA)
  NDMI_DOY[DOY, 2] <- NDMI_filt
  NDMI_smooth <- na_interpolation(x = NDMI_DOY, option = "linear")
  ls_field_filt2_smooth[[i]]$NDMI <- NDMI_smooth[,2]
  NDMI_smooth_peak <- subset(ls_field_filt2_smooth[[i]], DOY > 150 & DOY < 273)
  field_peak$peakV_NDMI[i] <- max(NDMI_smooth_peak$NDMI)
  field_peak$peakT_NDMI[i] <- which.max(NDMI_smooth_peak$NDMI)+150
  #NIRv
  NIRv_filt <- sgolayfilt(df$NIRv)
  NIRv_DOY <- cbind(1:365, NA)
  NIRv_DOY[DOY, 2] <- NIRv_filt
  NIRv_smooth <- na_interpolation(x = NIRv_DOY, option = "linear")
  ls_field_filt2_smooth[[i]]$NIRv <- NIRv_smooth[,2]
  NIRv_smooth_peak <- subset(ls_field_filt2_smooth[[i]], DOY > 150 & DOY < 273)
  field_peak$peakV_NIRv[i] <- max(NIRv_smooth_peak$NIRv)
  field_peak$peakT_NIRv[i] <- which.max(NIRv_smooth_peak$NIRv)+150
}
head(field_peak)
summary(field_peak$peakT_EVI)
summary(field_peak$peakV_EVI)
hist(field_peak$peakV_EVI)
sum(field_peak$peakV_EVI<0) #6
sum(field_peak$peakV_EVI<0.2) #165
sum(field_peak$peakV_NDVI<0.3) #165
sum(field_peak$peakV_NDVI<0.4) #285

sum(field_peak$peakV_EVI<=0.3) #371
sum(field_peak$peakT_EVI==151) #606
sum(field_peak_filt$peakT_EVI==272) #160

#remove fields that have low ndvi
field_peak_filt <- field_peak %>% dplyr::filter(peakV_NDVI>0.4)
filter_lowndvi <- which(field_peak$peakV_NDVI >= 0.4)
ls_field_filt2_smooth_filt <- ls_field_filt2_smooth[filter_lowndvi]
#calculate data

head(field_peak_filt)
head(ls_field_filt2_smooth[[1]])
field_peak_filt

length(ls_field_filt2_smooth)
names(ls_field_filt2_smooth) <- names(ls_field_filt2)

```
##peakT vs peakV
```{r}
names(field_peak_filt)
ggplot(field_peak_filt, aes(x = peakT_EVI, y = peakV_EVI)) + geom_point()
```

##Calculate weighted county-average
```{r}
#Combine with yield 

head(ls_field_filt2_smooth_filt[[1]])
head(field_peak_filt)
df_temp <- field_peak_filt %>% group_by(Area_acre, Year) %>% summarise("Area_acre"= unique(Area_acre), "County" = unique(County))
head(df_temp)
df_temp$Area_acre <- as.numeric(df_temp$Area_acre)
df_temp <- aggregate(df_temp[,"Area_acre"], by = list("County" = df_temp$County, "Year" = df_temp$Year), FUN = sum)
df_temp$Area_acre <- df_temp$Area_acre/4046.8564224
#add yield data to dataframe
df_temp <- merge(df_temp, yield_county, by = c("County","Year"))
names(df_temp)[c(3,6)] <- c("Area_NASS", "Area_Report")
ggplot(df_temp, aes(x = Area_NASS, y = Area_Report)) + geom_point()
county_peak_monthweighted <- merge(df_temp, field_peak_filt, by = c("Year", "County"))
head(county_peak_monthweighted)
dim(county_peak_monthweighted) #45881,25
county_peak_monthweighted$Area_acre<- as.numeric(county_peak_monthweighted$Area_acre)
#calculate area ratio 
county_peak_monthweighted$Area_ratio <- county_peak_monthweighted$Area_acre/4046.8564224/county_peak_monthweighted$Area_NASS
county_peak_monthweighted <- county_peak_monthweighted %>% group_by(County, Year) %>% summarise("peakT_EVI" = weighted.mean(peakT_EVI, Area_ratio),"peakV_EVI" = weighted.mean(peakV_EVI, Area_ratio), "peakT_NDVI" = weighted.mean(peakT_NDVI), "peakV_NDVI" = weighted.mean(peakV_NDVI), "peakT_EVI2" = weighted.mean(peakT_EVI2), "peakV_EVI2" = weighted.mean(peakV_EVI2), "peakT_WDRVI" = weighted.mean(peakT_WDRVI), "peakV_WDRVI" = weighted.mean(peakV_WDRVI), "peakT_NDMI" = weighted.mean(peakT_NDMI), "peakV_NDMI" = weighted.mean(peakV_NDMI), "peakT_NIRv" = weighted.mean(peakT_NIRv), "peakV_NIRv" = weighted.mean(peakV_NIRv))
head(county_peak_monthweighted)
#combine with yield 
county_peak_monthweighted_yield <- merge(county_peak_monthweighted, yield_county, by = c("Year","County"))
dim(county_peak_monthweighted) #162, 14
dim(county_peak_monthweighted_yield) #140, 22


```
##Correlation between VIs and Yield
```{r}
cor_vis5 <- cor(x = county_peak_monthweighted_yield[,3:14], y =  county_peak_monthweighted_yield[,c(16,18,19,21,22)], use = "complete.obs")
View(cor_vis5)

lm1 <- lm(Yield~peakV_NIRv + peakT_NIRv, data = county_peak_monthweighted_yield)
summary(lm1)

#Correlation coefficients
cor(county_peak_monthweighted_yield$Yield, county_peak_monthweighted_yield$peakV_EVI) #0.604
cor(county_peak_monthweighted_yield$Yield, county_peak_monthweighted_yield$peakV_NIRv) #0.609
cor(county_peak_monthweighted_yield$Yield, county_peak_monthweighted_yield$peakV_EVI2) #0.597
cor(county_peak_monthweighted_yield$Yield, county_peak_monthweighted_yield$peakV_NDMI) #0.560
cor(county_peak_monthweighted_yield$Yield, county_peak_monthweighted_yield$peakV_NDVI) #0.342


#Plots
p1 = ggscatter(county_peak_monthweighted_yield, x = "peakV_NIRv", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")
p2 = ggscatter(county_peak_monthweighted_yield, x = "peakT_NIRv", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")
grid.arrange(p1,p2, nrow = 2)
ggscatter(county_peak_monthweighted_yield, x = "peakV_EVI", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

ggplot(county_peak_monthweighted_yield, aes(x = peakV_NIRv, y = Yield)) + geom_point(aes(color = County)) + theme_bw() + geom_smooth(method = "lm")
ggplot(county_peak_monthweighted_yield, aes(x = peakV_EVI, y = Yield)) + geom_point(aes(color = County)) + theme_bw() + geom_smooth(method = "lm")
ggplot(county_peak_monthweighted_yield, aes(x = peakV_NDMI, y = Yield)) + geom_point(aes(color = County)) + theme_bw() + geom_smooth(method = "lm")
ggplot(county_peak_monthweighted_yield, aes(x = peakV_EVI2, y = Yield)) + geom_point(aes(color = County)) + theme_bw() + geom_smooth(method = "lm")

#linear regression
lm1 <- lm(data = county_peak_monthweighted_yield, Yield~peakV_NIRv)
summary(lm1)
lm2 <- lm(data = county_peak_monthweighted_yield, Yield~I(peakV_NIRv)^2+peakV_NIRv)
summary(lm2)
```
##Calculate county-level average daily VIs
```{r}
length(ls_field_filt2_smooth_filt) #49456
dim(field_peak_filt)  #49576
head(ls_field_filt2_smooth_filt[[1]])

df_field_smooth <- do.call(rbind, ls_field_filt2_smooth_filt)


#calculate the weighted ratio 
df_temp <- field_peak_filt %>% group_by(Area_acre, Year) %>% summarise("Area_acre"= unique(Area_acre), "County" = unique(County))
head(df_temp)
df_temp$Area_acre <- as.numeric(df_temp$Area_acre)
df_temp <- aggregate(df_temp[,"Area_acre"], by = list("County" = df_temp$County, "Year" = df_temp$Year), FUN = sum)
df_temp$Area_acre <- df_temp$Area_acre/4046.8564224
#add yield data to dataframe
df_temp <- merge(df_temp, yield_county, by = c("County","Year"))
names(df_temp)[c(3,6)] <- c("Area_NASS", "Area_Report")
ggplot(df_temp, aes(x = Area_NASS, y = Area_Report)) + geom_point()
county_peak_monthweighted <- merge(df_temp, field_peak_filt, by = c("Year", "County"))
head(county_peak_monthweighted)
dim(county_peak_monthweighted) #45881,25
county_peak_monthweighted$Area_acre<- as.numeric(county_peak_monthweighted$Area_acre)
#calculate area ratio 
county_peak_monthweighted$Area_ratio <- county_peak_monthweighted$Area_acre/4046.8564224/county_peak_monthweighted$Area_NASS
county_peak_monthweighted <- county_peak_monthweighted %>% group_by(County, Year) %>% summarise("peakT_EVI" = weighted.mean(peakT_EVI, Area_ratio),"peakV_EVI" = weighted.mean(peakV_EVI, Area_ratio), "peakT_NDVI" = weighted.mean(peakT_NDVI), "peakV_NDVI" = weighted.mean(peakV_NDVI), "peakT_EVI2" = weighted.mean(peakT_EVI2), "peakV_EVI2" = weighted.mean(peakV_EVI2), "peakT_WDRVI" = weighted.mean(peakT_WDRVI), "peakV_WDRVI" = weighted.mean(peakV_WDRVI), "peakT_NDMI" = weighted.mean(peakT_NDMI), "peakV_NDMI" = weighted.mean(peakV_NDMI), "peakT_NIRv" = weighted.mean(peakT_NIRv), "peakV_NIRv" = weighted.mean(peakV_NIRv))
head(county_peak_monthweighted)
#combine with yield 
county_peak_monthweighted_yield <- merge(county_peak_monthweighted, yield_county, by = c("Year","County"))
dim(county_peak_monthweighted) #162, 14
dim(county_peak_monthweighted_yield) #140, 22

```

#Extract useful information from each field
```{r}
pheno_extract <- function(ts){
  ls_field <- split(ts, ts$ID)
  #filter out some outliers 
  yesno <- rep(0, length(ls_field))
  for(i in 1:length(ls_field)){
    ls_field[[i]]$Month <- lubridate::month(ls_field[[i]]$Date)
    df_peak <- subset(ls_field[[i]], Month>=6 & Month <=9)
    if(max(df_peak$NDVI) < 0.5){
      yesno[i] <- (-1)
    }
    if(max(df_peak$NDVI) >= 0.5){
      yesno[i] <- 1
    }
  }
  print(length(which(yesno==-1)))
  #apply the filter
  ls_field_filt1 <- ls_field[which(yesno == 1)]

  #Extract phenology information 
  ##The dataframe to store the results
  field_sum <- data.frame("ID" = names(ls_field_filt1), "Year" = unique(lubridate::year(ls_field_filt1[[1]]$Date)), "UD_T"=0,"UD_V"=0, "SD_T"=0,"SD_V"=0, "DD_T"=0,"DD_V"=0,"RD_T" = 0, "RD_V" = 0, "max_T" = 0, "max_V"=0, "LengthGS"=0)
  for(i in 1:length(ls_field_filt1)){
    #subset
    df <- ls_field_filt1[[i]]
    #sort by date
    df <- df[order(df$Date),]
    #sgolay filter 
    #EVI_filt <- sgolayfilt(df$EVI)
    #phenofit package 
    curve_fit <- curvefit(y = df$EVI, t = yday(df$Date), tout = 1:365, methods = "Gu")
    pheno_stage <- get_pheno.fFITs(curve_fit, method = "Gu")
    fitted_value <- curve_fit$fFIT$Gu$zs$iter2
    #Extract useful information 
    ##Upturn date
    if(sum(is.na(pheno_stage$GU))==0){
      field_sum$UD_T[i] <- pheno_stage$GU[1]
      field_sum$UD_V[i] <- fitted_value[pheno_stage$GU[1]]
      ##stabilization date
      field_sum$SD_T[i] <- pheno_stage$GU[2]
      field_sum$SD_V[i] <- fitted_value[pheno_stage$GU[2]]
      ##downturn date
      field_sum$DD_T[i] <- pheno_stage$GU[3]
      field_sum$DD_V[i] <- fitted_value[pheno_stage$GU[3]]
      ##recession date 
      field_sum$RD_T[i] <- pheno_stage$GU[4]
      field_sum$RD_V[i] <- fitted_value[pheno_stage$GU[4]]
      #maximum value 
      field_sum$max_T[i] <- pheno_stage$GU[2]+which.max(fitted_value[pheno_stage$GU[2]:pheno_stage$GU[3]])-1
      field_sum$max_V[i] <- max(fitted_value[pheno_stage$GU[2]:pheno_stage$GU[3]])
      #length of gs 
      field_sum$LengthGS[i] <- field_sum$RD_T[i] - field_sum$UD_T[i]
    }
    else{
      field_sum[i,] <- NA
    }
  }
  #field_sum_narm <- na.omit(field_sum)

  return(field_sum)
}

#apply the function 
field_2013_sum <- pheno_extract(l8sr_ts_df_2013) #re-run
field_2014_sum <- pheno_extract(l8sr_ts_df_2014) #re-run
field_2015_sum <- pheno_extract(l8sr_ts_df_2015)

field_2016_sum <- pheno_extract(l8sr_ts_df_2016)
field_2017_sum <- pheno_extract(l8sr_ts_df_2017)
field_2018_sum <- pheno_extract(l8sr_ts_df_2018)
field_2019_sum <- pheno_extract(l8sr_ts_df_2019)
field_2013_sum <- pheno_extract(l8sr_ts_df_2013) #re-run
field_2014_sum <- pheno_extract(l8sr_ts_df_2014) #re-run

```

##Plot exploratory
```{r}
field_2013_sum_1 <- na.omit(field_2013_sum)
field_2014_sum_1 <- na.omit(field_2014_sum)
field_2015_sum_1 <- na.omit(field_2015_sum)
field_2016_sum_1 <- na.omit(field_2016_sum)
field_2017_sum_1 <- na.omit(field_2017_sum)
field_2018_sum_1 <- na.omit(field_2018_sum)
field_2019_sum_1 <- na.omit(field_2019_sum)
dim(field_2013_sum_1) #4896
dim(field_2014_sum_1) #6062
dim(field_2015_sum_1) #5250
dim(field_2016_sum_1) #error
dim(field_2017_sum_1) #2194
dim(field_2018_sum_1) #error
dim(field_2019_sum_1) #error

field_2013_sum_1 <- merge(field_2013_sum_1, tomato_fidbound_2013, by = c("Year","ID"))
field_2014_sum_1 <- merge(field_2014_sum_1, tomato_fidbound_2014, by = c("Year","ID"))
field_2015_sum_1 <- merge(field_2015_sum_1, tomato_fidbound_2015, by = c("Year","ID"))
field_2016_sum_1 <- merge(field_2016_sum_1, tomato_fidbound_2016, by = c("Year","ID"))
field_2017_sum_1 <- merge(field_2017_sum_1, tomato_fidbound_2017, by = c("Year","ID"))
field_2018_sum_1 <- merge(field_2018_sum_1, tomato_fidbound_2018, by = c("Year","ID"))
field_2019_sum_1 <- merge(field_2019_sum_1, tomato_fidbound_2019, by = c("Year","ID"))

field_sum_1 <- rbind(field_2013_sum_1, field_2014_sum_1, field_2015_sum_1, field_2017_sum_1)
dim(field_sum_1)
#merge with other 
field_sum_yield <- aggregate(field_sum_1[,c("UD_V","SD_V","DD_V","RD_V","max_V","LengthGS")], by = list("County" = field_sum_1$NAME, "Year" = field_sum_1$Year), FUN = mean)
field_sum_yield <- merge(field_sum_yield, yield_county_report, by = c("Year","County"))
dim(field_sum_yield)
head(field_sum_yield)
tail(field_sum_yield)
ggplot(field_sum_yield, aes(x = max_V, y = Yield)) + geom_point(aes(color = as.factor(Year))) + geom_smooth(method = "lm") + theme_bw()
ggplot(field_sum_yield, aes(x = UD_V, y = Yield)) + geom_point(aes(color = as.factor(Year))) + geom_smooth(method = "lm") + theme_bw()
ggplot(field_sum_yield, aes(x = SD_V, y = Yield)) + geom_point(aes(color = as.factor(Year))) + geom_smooth(method = "lm") + theme_bw()
ggplot(field_sum_yield, aes(x = DD_V, y = Yield)) + geom_point(aes(color = as.factor(Year))) + geom_smooth(method = "lm") + theme_bw()
ggplot(field_sum_yield, aes(x = RD_V, y = Yield)) + geom_point(aes(color = as.factor(Year))) + geom_smooth(method = "lm") + theme_bw()
ggplot(field_sum_yield, aes(x = LengthGS, y = Yield)) + geom_point(aes(color = as.factor(Year))) + geom_smooth(method = "lm") + theme_bw()
lm1 <- lm(Yield~max_V, field_sum_yield)
summary(lm1) #0.2945, p-value = 9.76e-05
lm2 <- lm(Yield~UD_V, field_sum_yield)
summary(lm2) #0.006, p-value = 0.602
lm3 <- lm(Yield~SD_V, field_sum_yield)
summary(lm3) #0.08595, p-value = 0.048
lm4 <- lm(Yield~DD_V, field_sum_yield)
summary(lm4) #0.2488, p-value = 0.0004
lm5 <- lm(Yield~LengthGS, field_sum_yield)
summary(lm5) #0.0195, p-value = 0.3547


ls_field_sum_yield_year <- split(field_sum_yield, field_sum_yield$Year)
for(i in 1:length(ls_field_sum_yield_year)){
  df <- ls_field_sum_yield_year[[i]]
  lm1 <- lm(Yield~EVI_max, df)
  print(summary(lm1))
}

head(field_sum_1)
```
##Combine with climate data
```{r}
field_sum_yield
```

#Merge different vis and phenology information 
```{r}

```
#-----------------Model Building ---------------------
#Monthly VIs
##Preprocessing  
```{r}
names(l578_county_monthweighted_yield)
dim(l578_county_monthweighted_yield) #140,106
sum(is.na(l578_county_monthweighted_yield)) #36
l578_county_monthweighted_yield <- l578_county_monthweighted_yield[,colSums(is.na(l578_county_monthweighted_yield))==0]
dim(l578_county_monthweighted_yield) #140.96

#solve multicollinearity problem
cor_cut_vis <- findCorrelation(cor(l578_county_monthweighted_yield[,c(11:94)]), cutoff = 0.7, verbose = TRUE, names = TRUE)
l578_county_monthweighted_yield_corcut <- cbind(l578_county_monthweighted_yield[,c(1:10)], l578_county_monthweighted_yield[,c(11:94)][cor_cut_vis])
names(l578_county_monthweighted_yield_corcut)
dim(l578_county_monthweighted_yield_corcut)  #140,79


set.seed(777) 
intrain <- createDataPartition(y = l578_county_monthweighted_yield_corcut$Yield, p = 0.7, list = FALSE)
training <- l578_county_monthweighted_yield_corcut[intrain,]
testing <- l578_county_monthweighted_yield_corcut[-intrain,]
traincrtl <- trainControl(method = "cv", number = 10)
```
##Feature reduction 
```{r}
to_test <- seq(1,10, by =1)
#recursive feature elimination 
rfectrl <- rfeControl(functions = rfFuncs, method = "cv", number = 10,verbose = FALSE)
fs_rfe_vis <- rfe(x = l578_county_monthweighted_yield_corcut[,c(11:79)], y = l578_county_monthweighted_yield_corcut$Yield, rfeControl = rfectrl, sizes = c(to_test))
select_rfeall_vis <- predictors(fs_rfe_vis)
select_rfe10_vis <- predictors(fs_rfe_vis)[1:10]
select_rfe5_vis <- predictors(fs_rfe_vis)[1:5]
```
##Model Building 
```{r}
set.seed(777)
traincrtl <- trainControl(method = "cv", number = 10)
#RF
rffit_vi_all <- train(Yield~., data = training[,c("Yield",select_rfeall_vis)], method = "rf", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.563
rffit_vi_all 
cor(stats::predict(rffit_vi_all,testing), testing$Yield)^2  #0.526
RMSE(stats::predict(rffit_vi_all,testing), testing$Yield)  #4.53
RPIQ(stats::predict(rffit_vi_all,testing), testing$Yield) #1.98

rffit_vi_10 <- train(Yield~., data = training[,c("Yield",select_rfe10_vis)], method = "rf", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
rffit_vi_10 
cor(stats::predict(rffit_vi_10,testing), testing$Yield)^2  #0.513
RMSE(stats::predict(rffit_vi_10,testing), testing$Yield)  #4.56
RPIQ(stats::predict(rffit_vi_10,testing), testing$Yield) #1.97

rffit_vi_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_vis)], method = "rf", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
rffit_vi_5 
cor(stats::predict(rffit_vi_5,testing), testing$Yield)^2  #0.577
RMSE(stats::predict(rffit_vi_5,testing), testing$Yield)  #4.24
RPIQ(stats::predict(rffit_vi_5,testing), testing$Yield) #2.12

#svm
svmfit_vi_all <- train(Yield~., data = training[,c("Yield",select_rfeall_vis)], method = "svmRadial", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.617
svmfit_vi_all 
cor(stats::predict(svmfit_vi_all,testing), testing$Yield)^2  #0.428
RMSE(stats::predict(svmfit_vi_all,testing), testing$Yield)  #4.97
RPIQ(stats::predict(svmfit_vi_all,testing), testing$Yield) #1.81
svmfit_vi_10 <- train(Yield~., data = training[,c("Yield",select_rfe10_vis)], method = "svmRadial", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
svmfit_vi_10 
cor(stats::predict(svmfit_vi_10,testing), testing$Yield)^2  #0.418
RMSE(stats::predict(svmfit_vi_10,testing), testing$Yield)  #4.99
RPIQ(stats::predict(svmfit_vi_10,testing), testing$Yield) #1.80
svmfit_vi_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_vis)], method = "svmRadial", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
svmfit_vi_5 
cor(stats::predict(svmfit_vi_5,testing), testing$Yield)^2  #0.526
RMSE(stats::predict(svmfit_vi_5,testing), testing$Yield)  #4.48
RPIQ(stats::predict(svmfit_vi_5,testing), testing$Yield) #2.00

#linear regression
lmfit_vi_10 <- train(Yield~., data = training[,c("Yield",select_rfe10_vis)], method = "lm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
lmfit_vi_10 
cor(stats::predict(lmfit_vi_10,testing), testing$Yield)^2  #0.559
RMSE(stats::predict(lmfit_vi_10,testing), testing$Yield)  #4.36
RPIQ(stats::predict(lmfit_vi_10,testing), testing$Yield) #2.06
lmfit_vi_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_vis)], method = "lm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
lmfit_vi_5 
cor(stats::predict(lmfit_vi_5,testing), testing$Yield)^2  #0.527
RMSE(stats::predict(lmfit_vi_5,testing), testing$Yield)  #4.59
RPIQ(stats::predict(lmfit_vi_5,testing), testing$Yield) #1.96

#plsr
plsrfit_vi_all <- train(Yield~., data = training[,c("Yield",select_rfeall_vis)], method = "pls", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.617
plsrfit_vi_all 
cor(stats::predict(plsrfit_vi_all,testing), testing$Yield)^2  #0.518
RMSE(stats::predict(plsrfit_vi_all,testing), testing$Yield)  #4.61
RPIQ(stats::predict(plsrfit_vi_all,testing), testing$Yield) #1.95
plsrfit_vi_10 <- train(Yield~., data = training[,c("Yield",select_rfe10_vis)], method = "pls", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
plsrfit_vi_10 
cor(stats::predict(plsrfit_vi_10,testing), testing$Yield)^2  #0.513
RMSE(stats::predict(plsrfit_vi_10,testing), testing$Yield)  #4.63
RPIQ(stats::predict(plsrfit_vi_10,testing), testing$Yield) #1.94
plsrfit_vi_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_vis)], method = "pls", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
plsrfit_vi_5 
cor(stats::predict(plsrfit_vi_5,testing), testing$Yield)^2  #0.499
RMSE(stats::predict(plsrfit_vi_5,testing), testing$Yield)  #4.75
RPIQ(stats::predict(plsrfit_vi_5,testing), testing$Yield) #1.89

#gbm
gbmfit_vi_all <- train(Yield~., data = training[,c("Yield",select_rfeall_vis)], method = "gbm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.617
gbmfit_vi_all 
cor(stats::predict(gbmfit_vi_all,testing), testing$Yield)^2  #0.482
RMSE(stats::predict(gbmfit_vi_all,testing), testing$Yield)  #4.78
RPIQ(stats::predict(gbmfit_vi_all,testing), testing$Yield) #1.88
gbmfit_vi_10 <- train(Yield~., data = training[,c("Yield",select_rfe10_vis)], method = "gbm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
gbmfit_vi_10 
cor(stats::predict(gbmfit_vi_10,testing), testing$Yield)^2  #0.511
RMSE(stats::predict(gbmfit_vi_10,testing), testing$Yield)  #4.56
RPIQ(stats::predict(gbmfit_vi_10,testing), testing$Yield) #1.97
gbmfit_vi_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_vis)], method = "gbm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
gbmfit_vi_5 
cor(stats::predict(gbmfit_vi_5,testing), testing$Yield)^2  #0.532
RMSE(stats::predict(gbmfit_vi_5,testing), testing$Yield)  #4.50
RPIQ(stats::predict(gbmfit_vi_5,testing), testing$Yield) #2.00



```
##Variable importance & partial dependence plot 
```{r}
p0 = plot(varImp(rffit_vi_5))
p1 = partial(rffit_vi_5, pred.var = c("EVI_6"), chull = TRUE, plot = TRUE)
p2 = partial(rffit_vi_5, pred.var = c("Green_4"), chull = TRUE, plot = TRUE)
p3 = partial(rffit_vi_5, pred.var = c("NDMI_5"), chull = TRUE, plot = TRUE)
p4 = partial(rffit_vi_5, pred.var = c("EVI_5"), chull = TRUE, plot = TRUE)
p5 = partial(rffit_vi_5, pred.var = c("NIR_7"), chull = TRUE, plot = TRUE)
grid.arrange(p0,p1,p2,p3,p4,p5, nrow = 2, ncol = 3)
```
#Weather only 
##preprocessing
```{r}
#solve multicollinearity problem
cor_cut_weather <- findCorrelation(cor(l578_county_monthweighted_yield_weather[,c(95:222)]), cutoff = 0.7, verbose = TRUE, names = TRUE)
county_yield_weather_corcut <- cbind(l578_county_monthweighted_yield_weather[,c(1:10)], l578_county_monthweighted_yield_weather[,c(95:222)][cor_cut_weather])
dim(county_yield_weather_corcut)  #140,69
names(county_yield_weather_corcut)

set.seed(777) 
intrain <- createDataPartition(y = l578_county_monthweighted_yield_weather$Yield, p = 0.7, list = FALSE)
training <- l578_county_monthweighted_yield_weather[intrain,]
testing <- l578_county_monthweighted_yield_weather[-intrain,]
traincrtl <- trainControl(method = "cv", number = 10)

```
##Feature reduction
```{r}
to_test <- seq(1,10, by =1)
#recursive feature elimination 
rfectrl <- rfeControl(functions = rfFuncs, method = "cv", number = 10,verbose = FALSE)
fs_rfe_weather <- rfe(x = county_yield_weather_corcut[,c(11:69)], y = county_yield_weather_corcut$Yield, rfeControl = rfectrl, sizes = c(to_test))
select_rfeall_weather <- predictors(fs_rfe_weather)
select_rfe10_weather <- predictors(fs_rfe_weather)[1:10]
select_rfe5_weather <- predictors(fs_rfe_weather)[1:5]
select_rfeall_weather
select_rfe10_weather
select_rfe5_weather


```
##Model building 
```{r}
set.seed(777)
traincrtl <- trainControl(method = "cv", number = 10)
#RF
rffit_weather_all <- train(Yield~., data = training[,c("Yield",select_rfeall_weather)], method = "rf", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  
rffit_weather_all 
cor(stats::predict(rffit_weather_all,testing), testing$Yield)^2  #0.372
RMSE(stats::predict(rffit_weather_all,testing), testing$Yield)  #4.99
RPIQ(stats::predict(rffit_weather_all,testing), testing$Yield) #1.81

rffit_weather_10 <- train(Yield~., data = training[,c("Yield",select_rfe10_weather)], method = "rf", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  
rffit_weather_10 
cor(stats::predict(rffit_weather_10,testing), testing$Yield)^2  #0.380
RMSE(stats::predict(rffit_weather_10,testing), testing$Yield)  #4.89
RPIQ(stats::predict(rffit_weather_10,testing), testing$Yield) #1.85

rffit_weather_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_weather)], method = "rf", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  
rffit_weather_5 
cor(stats::predict(rffit_weather_5,testing), testing$Yield)^2  #0.373
RMSE(stats::predict(rffit_weather_5,testing), testing$Yield)  #4.96
RPIQ(stats::predict(rffit_weather_5,testing), testing$Yield) #1.82


#svm
svmfit_weather_all <- train(Yield~., data = training[,c("Yield",select_rfeall_weather)], method = "svmRadial", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.617
svmfit_weather_all 
cor(stats::predict(svmfit_weather_all,testing), testing$Yield)^2  #0.428
RMSE(stats::predict(svmfit_weather_all,testing), testing$Yield)  #4.97
RPIQ(stats::predict(svmfit_weather_all,testing), testing$Yield) #1.81
svmfit_weather_10 <- train(Yield~., data = training[,c("Yield",select_rfe10_weather)], method = "svmRadial", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
svmfit_weather_10 
cor(stats::predict(svmfit_weather_10,testing), testing$Yield)^2  #0.418
RMSE(stats::predict(svmfit_weather_10,testing), testing$Yield)  #4.99
RPIQ(stats::predict(svmfit_weather_10,testing), testing$Yield) #1.80
svmfit_weather_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_weather)], method = "svmRadial", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
svmfit_weather_5 
cor(stats::predict(svmfit_weather_5,testing), testing$Yield)^2  #0.526
RMSE(stats::predict(svmfit_weather_5,testing), testing$Yield)  #4.48
RPIQ(stats::predict(svmfit_weather_5,testing), testing$Yield) #2.00

#linear regression
lmfit_weather_10 <- train(Yield~., data = training[,c("Yield",select_rfe10_weather)], method = "lm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
lmfit_weather_10 
cor(stats::predict(lmfit_weather_10,testing), testing$Yield)^2  #0.559
RMSE(stats::predict(lmfit_weather_10,testing), testing$Yield)  #4.36
RPIQ(stats::predict(lmfit_weather_10,testing), testing$Yield) #2.06
lmfit_weather_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_weather)], method = "lm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
lmfit_weather_5 
cor(stats::predict(lmfit_weather_5,testing), testing$Yield)^2  #0.527
RMSE(stats::predict(lmfit_weather_5,testing), testing$Yield)  #4.59
RPIQ(stats::predict(lmfit_weather_5,testing), testing$Yield) #1.96

#plsr
plsrfit_weather_all <- train(Yield~., data = training[,c("Yield",select_rfeall_weather)], method = "pls", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.617
plsrfit_weather_all 
cor(stats::predict(plsrfit_weather_all,testing), testing$Yield)^2  #0.518
RMSE(stats::predict(plsrfit_weather_all,testing), testing$Yield)  #4.61
RPIQ(stats::predict(plsrfit_weather_all,testing), testing$Yield) #1.95
plsrfit_weather_10 <- train(Yield~., data = training[,c("Yield",select_rfe10_weather)], method = "pls", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
plsrfit_weather_10 
cor(stats::predict(plsrfit_weather_10,testing), testing$Yield)^2  #0.513
RMSE(stats::predict(plsrfit_weather_10,testing), testing$Yield)  #4.63
RPIQ(stats::predict(plsrfit_weather_10,testing), testing$Yield) #1.94
plsrfit_weather_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_weather)], method = "pls", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
plsrfit_weather_5 
cor(stats::predict(plsrfit_weather_5,testing), testing$Yield)^2  #0.499
RMSE(stats::predict(plsrfit_weather_5,testing), testing$Yield)  #4.75
RPIQ(stats::predict(plsrfit_weather_5,testing), testing$Yield) #1.89

#gbm
gbmfit_weather_all <- train(Yield~., data = training[,c("Yield",select_rfeall_weather)], method = "gbm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.617
gbmfit_weather_all 
cor(stats::predict(gbmfit_weather_all,testing), testing$Yield)^2  #0.482
RMSE(stats::predict(gbmfit_weather_all,testing), testing$Yield)  #4.78
RPIQ(stats::predict(gbmfit_weather_all,testing), testing$Yield) #1.88
gbmfit_weather_10 <- train(Yield~., data = training[,c("Yield",select_rfe10_weather)], method = "gbm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
gbmfit_weather_10 
cor(stats::predict(gbmfit_weather_10,testing), testing$Yield)^2  #0.511
RMSE(stats::predict(gbmfit_weather_10,testing), testing$Yield)  #4.56
RPIQ(stats::predict(gbmfit_weather_10,testing), testing$Yield) #1.97
gbmfit_weather_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_weather)], method = "gbm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
gbmfit_weather_5 
cor(stats::predict(gbmfit_weather_5,testing), testing$Yield)^2  #0.532
RMSE(stats::predict(gbmfit_weather_5,testing), testing$Yield)  #4.50
RPIQ(stats::predict(gbmfit_weather_5,testing), testing$Yield) #2.00

```
##Variable importance & partial dependence plot 
```{r}
p0 = plot(varImp(rffit_weather_5))
p1 = partial(rffit_weather_5, pred.var = c("MinTemp_7"), chull = TRUE, plot = TRUE)
p2 = partial(rffit_weather_5, pred.var = c("MaxTemp_9"), chull = TRUE, plot = TRUE)
p3 = partial(rffit_weather_5, pred.var = c("MaxTemp_8"), chull = TRUE, plot = TRUE)
p4 = partial(rffit_weather_5, pred.var = c("vpd_8"), chull = TRUE, plot = TRUE)
p5 = partial(rffit_weather_5, pred.var = c("MaxTemp_7"), chull = TRUE, plot = TRUE)
grid.arrange(p0,p1,p2,p3,p4,p5, nrow = 2, ncol = 3)
```

#Peak VIs 
##Preprocessing 
```{r}
#solve multicollinearity problem
cor_cut_peakvis <- findCorrelation(cor(county_peak_monthweighted_yield[,c(3:14)]), cutoff = 0.7, verbose = TRUE, names = TRUE)
county_peakvis_corcut <- cbind(county_peak_monthweighted_yield[,c(1:2,15:22)], county_peak_monthweighted_yield[,c(3:14)][cor_cut_peakvis])
dim(county_peakvis_corcut)  #140,20
names(county_peakvis_corcut) 

set.seed(777) 
intrain <- createDataPartition(y = county_peak_monthweighted_yield$Yield, p = 0.7, list = FALSE)
training <- county_peak_monthweighted_yield[intrain,]
testing <- county_peak_monthweighted_yield[-intrain,]
traincrtl <- trainControl(method = "cv", number = 10)

dim(county_peak_monthweighted_yield)
```
##Feauture reduction
```{r}
to_test <- seq(1,10, by =1)
#recursive feature elimination 
rfectrl <- rfeControl(functions = rfFuncs, method = "cv", number = 10,verbose = FALSE)
fs_rfe_peakvis <- rfe(x = county_peakvis_corcut[,c(11:20)], y = county_peakvis_corcut$Yield, rfeControl = rfectrl, sizes = c(to_test))
select_rfeall_peakvis <- predictors(fs_rfe_peakvis)
select_rfe5_peakvis <- predictors(fs_rfe_peakvis)[1:5]
select_rfe3_peakvis <- predictors(fs_rfe_peakvis)[1:3]
select_rfeall_peakvis
select_rfe5_peakvis
select_rfe3_peakvis
```
##Model Building
```{r}
set.seed(777)
traincrtl <- trainControl(method = "cv", number = 10)
#RF
rffit_peakvi_all <- train(Yield~., data = training[,c("Yield",select_rfeall_peakvis)], method = "rf", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.563
rffit_peakvi_all 
cor(stats::predict(rffit_peakvi_all,testing), testing$Yield)^2  #0.526
RMSE(stats::predict(rffit_peakvi_all,testing), testing$Yield)  #4.53
RPIQ(stats::predict(rffit_peakvi_all,testing), testing$Yield) #1.98

rffit_peakvi_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_peakvis)], method = "rf", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
rffit_peakvi_5 
cor(stats::predict(rffit_peakvi_5,testing), testing$Yield)^2  #0.513
RMSE(stats::predict(rffit_peakvi_5,testing), testing$Yield)  #4.56
RPIQ(stats::predict(rffit_peakvi_5,testing), testing$Yield) #1.97

rffit_peakvi_3 <- train(Yield~., data = training[,c("Yield",select_rfe3_peakvis)], method = "rf", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
rffit_peakvi_3 
cor(stats::predict(rffit_peakvi_3,testing), testing$Yield)^2  #0.577
RMSE(stats::predict(rffit_peakvi_3,testing), testing$Yield)  #4.24
RPIQ(stats::predict(rffit_peakvi_3,testing), testing$Yield) #2.12

#svm
svmfit_peakvi_all <- train(Yield~., data = training[,c("Yield",select_rfeall_peakvis)], method = "svmRadial", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.617
svmfit_peakvi_all 
cor(stats::predict(svmfit_peakvi_all,testing), testing$Yield)^2  #0.428
RMSE(stats::predict(svmfit_peakvi_all,testing), testing$Yield)  #4.97
RPIQ(stats::predict(svmfit_peakvi_all,testing), testing$Yield) #1.81
svmfit_peakvi_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_peakvis)], method = "svmRadial", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
svmfit_peakvi_5 
cor(stats::predict(svmfit_peakvi_5,testing), testing$Yield)^2  #0.418
RMSE(stats::predict(svmfit_peakvi_5,testing), testing$Yield)  #4.99
RPIQ(stats::predict(svmfit_peakvi_5,testing), testing$Yield) #1.80
svmfit_peakvi_3 <- train(Yield~., data = training[,c("Yield",select_rfe3_peakvis)], method = "svmRadial", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
svmfit_peakvi_3 
cor(stats::predict(svmfit_peakvi_3,testing), testing$Yield)^2  #0.526
RMSE(stats::predict(svmfit_peakvi_3,testing), testing$Yield)  #4.48
RPIQ(stats::predict(svmfit_peakvi_3,testing), testing$Yield) #2.00

#linear regression
lmfit_peakvi_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_peakvis)], method = "lm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
lmfit_peakvi_5 
cor(stats::predict(lmfit_peakvi_5,testing), testing$Yield)^2  #0.559
RMSE(stats::predict(lmfit_peakvi_5,testing), testing$Yield)  #4.36
RPIQ(stats::predict(lmfit_peakvi_5,testing), testing$Yield) #2.06
lmfit_peakvi_3 <- train(Yield~., data = training[,c("Yield",select_rfe3_peakvis)], method = "lm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
lmfit_peakvi_3 
cor(stats::predict(lmfit_peakvi_3,testing), testing$Yield)^2  #0.527
RMSE(stats::predict(lmfit_peakvi_3,testing), testing$Yield)  #4.59
RPIQ(stats::predict(lmfit_peakvi_3,testing), testing$Yield) #1.96

#plsr
plsrfit_peakvi_all <- train(Yield~., data = training[,c("Yield",select_rfeall_peakvis)], method = "pls", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.617
plsrfit_peakvi_all 
cor(stats::predict(plsrfit_peakvi_all,testing), testing$Yield)^2  #0.518
RMSE(stats::predict(plsrfit_peakvi_all,testing), testing$Yield)  #4.61
RPIQ(stats::predict(plsrfit_peakvi_all,testing), testing$Yield) #1.95
plsrfit_peakvi_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_peakvis)], method = "pls", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
plsrfit_peakvi_5 
cor(stats::predict(plsrfit_peakvi_5,testing), testing$Yield)^2  #0.513
RMSE(stats::predict(plsrfit_peakvi_5,testing), testing$Yield)  #4.63
RPIQ(stats::predict(plsrfit_peakvi_5,testing), testing$Yield) #1.94
plsrfit_peakvi_3 <- train(Yield~., data = training[,c("Yield",select_rfe3_peakvis)], method = "pls", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
plsrfit_peakvi_3 
cor(stats::predict(plsrfit_peakvi_3,testing), testing$Yield)^2  #0.499
RMSE(stats::predict(plsrfit_peakvi_3,testing), testing$Yield)  #4.75
RPIQ(stats::predict(plsrfit_peakvi_3,testing), testing$Yield) #1.89

#gbm
gbmfit_peakvi_all <- train(Yield~., data = training[,c("Yield",select_rfeall_peakvis)], method = "gbm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.617
gbmfit_peakvi_all 
cor(stats::predict(gbmfit_peakvi_all,testing), testing$Yield)^2  #0.482
RMSE(stats::predict(gbmfit_peakvi_all,testing), testing$Yield)  #4.78
RPIQ(stats::predict(gbmfit_peakvi_all,testing), testing$Yield) #1.88
gbmfit_peakvi_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_peakvis)], method = "gbm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
gbmfit_peakvi_5 
cor(stats::predict(gbmfit_peakvi_5,testing), testing$Yield)^2  #0.511
RMSE(stats::predict(gbmfit_peakvi_5,testing), testing$Yield)  #4.56
RPIQ(stats::predict(gbmfit_peakvi_5,testing), testing$Yield) #1.97
gbmfit_peakvi_3 <- train(Yield~., data = training[,c("Yield",select_rfe3_peakvis)], method = "gbm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
gbmfit_peakvi_3 
cor(stats::predict(gbmfit_peakvi_3,testing), testing$Yield)^2  #0.532
RMSE(stats::predict(gbmfit_peakvi_3,testing), testing$Yield)  #4.50
RPIQ(stats::predict(gbmfit_peakvi_3,testing), testing$Yield) #2.00


```

#Monthly peakvis + Weather + monthly vis

##Feature selection 
```{r}
to_test <- seq(1,10, by =1)
#recursive feature elimination 
rfectrl <- rfeControl(functions = rfFuncs, method = "cv", number = 10,verbose = FALSE)

all_county_monthweighted <- base::merge(l578_county_monthweighted_yield_weather, county_peak_monthweighted, by = c("County","Year"))
names(all_county_monthweighted)
dim(all_county_monthweighted) #140, 234
all_county_monthweighted_select <- all_county_monthweighted[,c("County","Year","Yield","Green_4","NDMI_5","EVI_6","EVI_5","NIR_7","MinTemp_7","MaxTemp_9","MaxTemp_8","vpd_8","MaxTemp_7","peakV_EVI","peakT_WDRVI","peakV_NIRv")]


fs_rfe_all <- rfe(x = all_county_monthweighted_select[,c(4:16)], y = all_county_monthweighted_select$Yield, rfeControl = rfectrl, sizes = c(to_test))

select_rfeall_all <- predictors(fs_rfe_all)
select_rfeall_all


```
##Preprocessing
```{r}
set.seed(777) 
intrain <- createDataPartition(y = all_county_monthweighted_select$Yield, p = 0.7, list = FALSE)
training <- all_county_monthweighted_select[intrain,]
testing <- all_county_monthweighted_select[-intrain,]
traincrtl <- trainControl(method = "cv", number = 10)

```

##Model Building 
```{r}
set.seed(777)
traincrtl <- trainControl(method = "cv", number = 10)
#RF
rffit_all_all <- train(Yield~., data = training[,c("Yield",select_rfeall_all)], method = "rf", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.563
rffit_all_all 
cor(stats::predict(rffit_all_all,testing), testing$Yield)^2  #0.526
RMSE(stats::predict(rffit_all_all,testing), testing$Yield)  #4.53
RPIQ(stats::predict(rffit_all_all,testing), testing$Yield) #1.98

rffit_all_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_all)], method = "rf", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
rffit_all_5 
cor(stats::predict(rffit_all_5,testing), testing$Yield)^2  #0.513
RMSE(stats::predict(rffit_all_5,testing), testing$Yield)  #4.56
RPIQ(stats::predict(rffit_all_5,testing), testing$Yield) #1.97

rffit_all_3 <- train(Yield~., data = training[,c("Yield",select_rfe3_all)], method = "rf", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
rffit_all_3 
cor(stats::predict(rffit_all_3,testing), testing$Yield)^2  #0.577
RMSE(stats::predict(rffit_all_3,testing), testing$Yield)  #4.24
RPIQ(stats::predict(rffit_all_3,testing), testing$Yield) #2.12

#svm
svmfit_all_all <- train(Yield~., data = training[,c("Yield",select_rfeall_all)], method = "svmRadial", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.617
svmfit_all_all 
cor(stats::predict(svmfit_all_all,testing), testing$Yield)^2  #0.428
RMSE(stats::predict(svmfit_all_all,testing), testing$Yield)  #4.97
RPIQ(stats::predict(svmfit_all_all,testing), testing$Yield) #1.81
svmfit_all_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_all)], method = "svmRadial", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
svmfit_all_5 
cor(stats::predict(svmfit_all_5,testing), testing$Yield)^2  #0.418
RMSE(stats::predict(svmfit_all_5,testing), testing$Yield)  #4.99
RPIQ(stats::predict(svmfit_all_5,testing), testing$Yield) #1.80
svmfit_all_3 <- train(Yield~., data = training[,c("Yield",select_rfe3_all)], method = "svmRadial", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
svmfit_all_3 
cor(stats::predict(svmfit_all_3,testing), testing$Yield)^2  #0.526
RMSE(stats::predict(svmfit_all_3,testing), testing$Yield)  #4.48
RPIQ(stats::predict(svmfit_all_3,testing), testing$Yield) #2.00

#linear regression
lmfit_all_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_all)], method = "lm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
lmfit_all_5 
cor(stats::predict(lmfit_all_5,testing), testing$Yield)^2  #0.559
RMSE(stats::predict(lmfit_all_5,testing), testing$Yield)  #4.36
RPIQ(stats::predict(lmfit_all_5,testing), testing$Yield) #2.06
lmfit_all_3 <- train(Yield~., data = training[,c("Yield",select_rfe3_all)], method = "lm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
lmfit_all_3 
cor(stats::predict(lmfit_all_3,testing), testing$Yield)^2  #0.527
RMSE(stats::predict(lmfit_all_3,testing), testing$Yield)  #4.59
RPIQ(stats::predict(lmfit_all_3,testing), testing$Yield) #1.96

#plsr
plsrfit_all_all <- train(Yield~., data = training[,c("Yield",select_rfeall_all)], method = "pls", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.617
plsrfit_all_all 
cor(stats::predict(plsrfit_all_all,testing), testing$Yield)^2  #0.518
RMSE(stats::predict(plsrfit_all_all,testing), testing$Yield)  #4.61
RPIQ(stats::predict(plsrfit_all_all,testing), testing$Yield) #1.95
plsrfit_all_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_all)], method = "pls", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
plsrfit_all_5 
cor(stats::predict(plsrfit_all_5,testing), testing$Yield)^2  #0.513
RMSE(stats::predict(plsrfit_all_5,testing), testing$Yield)  #4.63
RPIQ(stats::predict(plsrfit_all_5,testing), testing$Yield) #1.94
plsrfit_all_3 <- train(Yield~., data = training[,c("Yield",select_rfe3_all)], method = "pls", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
plsrfit_all_3 
cor(stats::predict(plsrfit_all_3,testing), testing$Yield)^2  #0.499
RMSE(stats::predict(plsrfit_all_3,testing), testing$Yield)  #4.75
RPIQ(stats::predict(plsrfit_all_3,testing), testing$Yield) #1.89

#gbm
gbmfit_all_all <- train(Yield~., data = training[,c("Yield",select_rfeall_all)], method = "gbm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.617
gbmfit_all_all 
cor(stats::predict(gbmfit_all_all,testing), testing$Yield)^2  #0.482
RMSE(stats::predict(gbmfit_all_all,testing), testing$Yield)  #4.78
RPIQ(stats::predict(gbmfit_all_all,testing), testing$Yield) #1.88
gbmfit_all_5 <- train(Yield~., data = training[,c("Yield",select_rfe5_all)], method = "gbm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.566
gbmfit_all_5 
cor(stats::predict(gbmfit_all_5,testing), testing$Yield)^2  #0.511
RMSE(stats::predict(gbmfit_all_5,testing), testing$Yield)  #4.56
RPIQ(stats::predict(gbmfit_all_5,testing), testing$Yield) #1.97
gbmfit_all_3 <- train(Yield~., data = training[,c("Yield",select_rfe3_all)], method = "gbm", trControl = traincrtl, tuneLength = 10, verbose = FALSE)  #r^2 = 0.578
gbmfit_all_3 
cor(stats::predict(gbmfit_all_3,testing), testing$Yield)^2  #0.532
RMSE(stats::predict(gbmfit_all_3,testing), testing$Yield)  #4.50
RPIQ(stats::predict(gbmfit_all_3,testing), testing$Yield) #2.00

```
##Model evaluation
```{r}
a <- data.frame("Predicted_Yield"=stats::predict(rffit_all_all, testing),"Observed_Yield"=testing$Yield)
a$Class <- "Testing"
b <- data.frame("Predicted_Yield"=stats::predict(rffit_all_all, training),"Observed_Yield"=training$Yield)
b$Class <- "Training"
ab <- rbind(a,b)
ab$Class <- as.factor(ab)
ggplot(ab, aes(x = Observed_Yield, y = Predicted_Yield, color = Class)) + geom_point() + theme_bw() + geom_smooth(method = "lm", se =FALSE)  + xlab("Observed_Yield (tons/acre)") + ylab("Predicted_Yield (tons/acre)") + geom_abline(intercept = 0, slope = 1) + xlim(35,65) + ylim(35,65)
summary(lm(a$Predicted_Yield~a$Observed_Yield))
summary(lm(b$Predicted_Yield~b$Observed_Yield))

```

#----------------Validatino with RR: Begin--------------------------
#Russell Ranch Validation using the field-level data from RR
```{r}
path_rr_shp <- "C:/Users/tangz/Box Sync/CC_UCD_RR/Shapefiles"
list.files(path_rr_shp, pattern = ".shp")
RR_BND <- shapefile(file.path(path_rr_shp, "RR_BND_sen2.shp"))

```
##Read Data from GEE
```{r}
path_rr_gee <- "D:/Tomato_Phenology_RemoteSensing/GEE_output/RussellRanch_Landsat"
l5sr_rr_names <- list.files(path_rr_gee, full.names = TRUE, pattern = "L5")
l7sr_rr_names <- list.files(path_rr_gee, full.names = TRUE, pattern = "L7")
l8sr_rr_names <- list.files(path_rr_gee, full.names = TRUE, pattern = "L8")
l5sr_rr_list <- list()
l7sr_rr_list <- list()
l8sr_rr_list <- list()

#Landsat 5
for(i in 1:length(l5sr_rr_names)){
  df <- read.csv(l5sr_rr_names[i]) 
  head(df)
  #subset
  df <- df[,c(1:23)]
  df <- df[,c("FieldID","imageId","mean")]
  df$Date <- as.Date(sapply(strsplit(df$imageId, split = "_"),'[',3), "%Y%m%d")
  #remove NAs
  sum(is.na(df))
  #change names
  #names(df) <- c("FieldID","imageId","mean","Date")
  #if there are two values per date, average it
  df$Band <- unlist(ex_between(l5sr_rr_names[i], left = "L5_", right = ".csv", extract = TRUE))
  #scale the values
  df$mean <- df$mean * 0.0001
  #add year and month 
  df$Year <- lubridate::year(df$Date)
  df$Month <- lubridate::month(df$Date)
  #change classes
  df$FieldID <- as.factor(df$FieldID)
  df$Band <- as.factor(df$Band)
  #store in the list 
  l5sr_rr_list[[i]] <- df
} 

#Landsat 7
for(i in 1:length(l7sr_rr_names)){
  df <- read.csv(l7sr_rr_names[i]) 
  head(df)
  #subset
  df <- df[,c(1:23)]
  df <- df[,c("FieldID","imageId","mean")]
  df$Date <- as.Date(sapply(strsplit(df$imageId, split = "_"),'[',3), "%Y%m%d")
  #remove NAs
  sum(is.na(df))
  #change names
  #names(df) <- c("FieldID","imageId","mean","Date")
  #if there are two values per date, average it
  df$Band <- unlist(ex_between(l7sr_rr_names[i], left = "L7_", right = ".csv", extract = TRUE))
  #scale the values
  df$mean <- df$mean * 0.0001
  #add year and month 
  df$Year <- lubridate::year(df$Date)
  df$Month <- lubridate::month(df$Date)
  #change classes
  df$FieldID <- as.factor(df$FieldID)
  df$Band <- as.factor(df$Band)
  #store in the list 
  l7sr_rr_list[[i]] <- df
} 

#Landsat 8
for(i in 1:length(l8sr_rr_names)){
  df <- read.csv(l8sr_rr_names[i]) 
  head(df)
  #subset
  df <- df[,c(1:23)]
  df <- df[,c("FieldID","imageId","mean")]
  df$Date <- as.Date(sapply(strsplit(df$imageId, split = "_"),'[',3), "%Y%m%d")
  #remove NAs
  sum(is.na(df))
  #change names
  #names(df) <- c("FieldID","imageId","mean","Date")
  #if there are two values per date, average it
  df$Band <- unlist(ex_between(l8sr_rr_names[i], left = "L8_", right = ".csv", extract = TRUE))
  #scale the values
  df$mean <- df$mean * 0.0001
  #add year and month 
  df$Year <- lubridate::year(df$Date)
  df$Month <- lubridate::month(df$Date)
  #change classes
  df$FieldID <- as.factor(df$FieldID)
  df$Band <- as.factor(df$Band)
  #store in the list 
  l8sr_rr_list[[i]] <- df
} 

#change the list to df
l5sr_rr_df <- do.call(rbind, l5sr_rr_list)
head(l5sr_rr_df)
tail(l5sr_rr_df)
dim(l5sr_rr_df) #25830, 7
sum(is.na(l5sr_rr_df)) #0

l7sr_rr_df <- do.call(rbind, l7sr_rr_list)
head(l7sr_rr_df)
tail(l7sr_rr_df)
dim(l7sr_rr_df) #75895,7
sum(is.na(l7sr_rr_df)) #0

l8sr_rr_df <- do.call(rbind, l8sr_rr_list)
head(l8sr_rr_df)
tail(l8sr_rr_df)
dim(l8sr_rr_df) #52738,7
sum(is.na(l8sr_rr_df)) #0

#convert long to wide 
l5sr_rr_df <- spread(l5sr_rr_df, key = "Band", value = "mean")
l7sr_rr_df <- spread(l7sr_rr_df, key = "Band", value = "mean")
l8sr_rr_df <- spread(l8sr_rr_df, key = "Band", value = "mean")
```
##Calculate VIs
```{r}
l5sr_rr_df <- addVIs_l57(l5sr_rr_df)
l7sr_rr_df <- addVIs_l57(l7sr_rr_df)
l8sr_rr_df <- addVIs_l8(l8sr_rr_df)
#l7sr_ts_df <- addVIs_l57(l7sr_ts_df)
names(l5sr_rr_df)[6:11] <- c("Blue","Green","Red","NIR","SWIR1","SWIR2")
names(l7sr_rr_df)[6:11] <- c("Blue","Green","Red","NIR","SWIR1","SWIR2")
names(l8sr_rr_df)[7:12] <- c("Blue","Green","Red","NIR","SWIR1","SWIR2")
l8sr_rr_df$B1 <- NULL
#add NIRv
l5sr_rr_df$NIRv <- l5sr_rr_df$NIR * l5sr_rr_df$NDVI
l7sr_rr_df$NIRv <- l7sr_rr_df$NIR * l7sr_rr_df$NDVI
l8sr_rr_df$NIRv <- l8sr_rr_df$NIR * l8sr_rr_df$NDVI
#add sensor name 
l5sr_rr_df$Sensor <- "L5"
l7sr_rr_df$Sensor <- "L7"
l8sr_rr_df$Sensor <- "L8"


#merge them together
l578_rr_df <- rbind(l5sr_rr_df, l7sr_rr_df, l8sr_rr_df)
head(l578_rr_df)
dim(l578_rr_df) #26157,18
dim(subset(l578_rr_df, Year >= 2008)) #26157, 18
sum(is.na(l8sr_rr_df)) #0

#replace "-' with "_"
l578_rr_df$FieldID <- gsub(pattern = "-", replacement = "_",l578_rr_df$FieldID)
str(l578_rr_df)
l578_rr_df$Sensor <- as.factor(l578_rr_df$Sensor)
l578_rr_df$FieldID <- as.factor(l578_rr_df$FieldID)

```
##Combine with yield data
```{r}
path_rr_df <- "C:/Users/tangz/Box Sync/CC_UCD_RR/Dataframes"
path_df <- "D:/Tomato_Phenology_RemoteSensing/Dataframes"

yield_rr_9419 <- read.csv(file.path(path_df, "RR_Yield_1994_2019.csv"))
yield_rr_9419 <- yield_rr_9419[,c("year","plot_code","plot_side","block","system_code","irrigation","cash_crop_planted","cash_crop_date_planted","cash_crop_date_harvested","tomato_machineharvest_marketablefruitfreshwt_tonsha")]
names(yield_rr_9419) <- c("Year","FieldID","plot_side","block","system_code","irrigation","crop","plant_date","harv_date","Yield")
yield_rr_9419 <- subset(yield_rr_9419, crop == "Tomato")
dim(yield_rr_9419)
head(yield_rr_9419)
yield_rr_9419 <- yield_rr_9419 %>% group_by(Year, FieldID) %>% summarise(Yield = mean(Yield, na.rm = TRUE), plant_date = unique(plant_date), harv_date = unique(harv_date))
yield_rr_9419$Yield <- yield_rr_9419$Yield * 0.404686 #convert tons/ha to tons/acre
yield_rr_9419$Year_Field <- paste(yield_rr_9419$Year, yield_rr_9419$FieldID, sep = "_")
length(unique(subset(yield_rr_9419, Year >= 2008)$Year_Field))  #170
yield_rr_9419 <- na.omit(yield_rr_9419)
dim(subset(yield_rr_9419, Year >=2008))  #167,6



#yield_rr <- read.csv(file.path(path_rr_df, "RR_tomyld9419.csv"))
#head(yield_rr_9419)
#head(yield_rr)
#head(yield_rr)
#names(yield_rr)[1:2] <- c("Year","FieldID")
#dim(yield_rr) #364,8
#yield_rr$yield <- yield_rr$yield * 0.404686
#yield_rr %>% dplyr::filter(Year >= 2008) %>% group_by(Year) %>% summarise(length(FieldID))



l578_rr_yield <- base::merge(l578_rr_df, yield_rr_9419, by = c("Year","FieldID"))
dim(l578_rr_yield) #5042, 22
l578_rr_yield$DOY <- as.numeric(strftime(l578_rr_yield$Date, format = "%j"))
l578_rr_yield$plant_DOY <-  as.numeric(strftime(l578_rr_yield$plant_date, format = "%j"))
l578_rr_yield$harv_DOY <-  as.numeric(strftime(l578_rr_yield$harv_date, format = "%j"))


l578_rr_yield %>% group_by(Year) %>% summarise(length(unique(FieldID)))
```
##The temporal change of Yield
```{r}
ggplot(subset(yield_rr_9419, Year >= 2008), aes(x = Year, y = yield, col = as.factor(irrigation))) + geom_point() 

ggplot(subset(l578_rr_yield, Year >= 2008), aes(x = Year, y = Yield)) + geom_point() 

ggplot(subset(l578_rr_yield, Year >= 2008), aes(x = Year, y = yield)) + geom_point(size = 2) + theme_bw() + ylab("Yield (tons/acre)") + scale_x_continuous(breaks = seq(2008, 2019, 3)) + guides(color=guide_legend(title="Irrigation"))  + geom_line(data = subset(yield_county, County == "Yolo"), aes(x = Year, y = Yield), size = 1.5) + geom_point(data = subset(yield_county, County == "Yolo"), aes(x = Year, y = Yield)) + stat_summary(aes(y = yield,group=1), fun.y=mean, colour="red", geom="line",group=1, size = 1.5) + theme(text = element_text(size = 15))      

ggplot(subset(l578_rr_yield, Year >= 2008), aes(x = Year, y = Yield)) + geom_point(size = 2) + theme_bw() + ylab("Yield (tons/acre)") + scale_x_continuous(breaks = seq(2008, 2019, 3))   + geom_line(data = subset(yield_county, County == "Yolo"), aes(x = Year, y = Yield), size = 1.5, color = "red") + geom_point(data = subset(yield_county, County == "Yolo"), aes(x = Year, y = Yield)) + stat_summary(aes(y = Yield,group=1), fun.y=mean, colour="black", geom="line",group=1, size = 1.5) + theme(text = element_text(size = 15))      

```
##Monthly VIs
```{r}
names(l578_rr_yield)
names(l578_county_month)

l578_rr_month <- aggregate(subset(l578_rr_yield, Month %in% c(4:10))[,c("Blue","Green","Red","NIR","SWIR1","SWIR2","NDVI","EVI","EVI2","WDRVI","NDMI","NIRv")], by = list("Year" = subset(l578_rr_yield, Month %in% c(4:10))$Year, "FieldID" = subset(l578_rr_yield, Month %in% c(4:10))$FieldID, "Month" = subset(l578_rr_yield, Month %in% c(4:10))$Month), FUN = mean)
#merge with yield 
l578_rr_month_yield <- merge(l578_rr_month, yield_rr_9419, by = c("Year","FieldID"))
dim(l578_rr_month_yield)
#convert long to wide/
l578_rr_month_yield <- tidyr::pivot_wider(data = l578_rr_month_yield, names_from = Month, values_from = Blue:NIRv)
#l578_rr_month_yield$Year <- as.factor(l578_rr_month_yield$Year)
#l578_county_monthweighted_yield <- tidyr::pivot_wider(data = l578_county_monthweighted_yield, names_from =  Month, values_from = Blue:NIRv)

head(l578_rr_month)

head(l578_rr_month)
dim(l578_rr_month_yield) #167,90


cor1 <- cor(l578_rr_month_yield$Yield, l578_rr_month_yield[,c(7:90)])
View(t(cor1))
dim(l578_rr_month_yield) #167,90
sum(is.na(l578_rr_month_yield)) #0


ggplot(l578_rr_month_yield, aes(x=yield,y=NIR_7)) + geom_point() + theme_bw()



p1 = ggscatter(l578_rr_month_yield, x = "NIRv_7", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")
p1
p2 = ggscatter(l578_rr_month_yield, x = "SWIR2_7", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")
p2
p3 = ggscatter(l578_rr_month_yield, x = "NDMI_9", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")
p3
ggscatter(l578_rr_month_yield, x = "NIRv_7", y = "Yield", add = "reg.line", color = "Year") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")
p2 = ggscatter(l578_rr_month_yield, x = "SWIR2_7", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")
p2
grid.arrange(p1,p2, nrow = 2)


```
##Weather data
```{r}
path_cimis <- "D:/Tomato_Phenology_RemoteSensing/CIMIS"
weather_davis <- read.csv(file.path(path_cimis, "CIMISdaily_Davis_20080101_20191231.csv"))
head(weather_davis)
names(weather_davis)

weather_davis$Date <- as.Date(as.character(weather_davis$Date), "%m/%d/%Y")
#SUBSET
weather_davis <- weather_davis[,c("Date","Max.Air.Temp..C.","Min.Air.Temp..C.","Avg.Rel.Hum....","ETo..mm.","Precip..mm.","Sol.Rad..W.sq.m.","Avg.Wind.Speed..m.s.")]
head(weather_davis)
names(weather_davis) <- c("Date","MaxTemp","MinTemp","RH","ETo","Precip","srad","vs")
head(weather_davis)
#add some columns 
head(weather_county_wide)
weather_davis$Year <- lubridate::year(weather_davis$Date)
weather_davis$Month <- lubridate::month(weather_davis$Date)
sum(is.na(weather_davis))
weather_davis <- na.omit(weather_davis)
#add DOY
weather_davis$DOY <-as.numeric(strftime(weather_davis$Date, format = "%j"))
```
###Monthly Average weather 
```{r}
l578_rr_month <- aggregate(subset(l578_rr_yield, Month %in% c(4:10))[,c("Blue","Green","Red","NIR","SWIR1","SWIR2","NDVI","EVI","EVI2","WDRVI","NDMI","NIRv")], by = list("Year" = subset(l578_rr_yield, Month %in% c(4:10))$Year, "FieldID" = subset(l578_rr_yield, Month %in% c(4:10))$FieldID, "Month" = subset(l578_rr_yield, Month %in% c(4:10))$Month), FUN = mean)

weather_rr_month <- aggregate(subset(weather_davis, Month %in% c(4:10))[,c("MaxTemp","MinTemp","RH","ETo","Precip","srad","vs")], by = list("Year"=subset(weather_davis, Month %in% c(4:10))$Year, "Month" = subset(weather_davis, Month %in% c(4:10))$Month), FUN = mean)
#convert long to wide 
weather_rr_wide <- tidyr::pivot_wider(weather_rr_month, names_from = Month, values_from = MaxTemp:vs)
head(weather_rr_month)
head(weather_rr_wide)
View(weather_rr_wide)
```

###Extreme weather events 
```{r}
#monthly average from 2018 
##Extreme hot 
extreme_tmax_rr <- aggregate(weather_davis$MaxTemp, by = list("Month" = weather_davis$Month), FUN = function(x){quantile(x, probs = 0.9)})
names(extreme_tmax_rr)[2] <- "thresh"
maxtemp_daily_rr <- merge(weather_davis, extreme_tmax_rr, by = c("Month"))
head(maxtemp_daily_rr)
extreme_tmax_rr <- maxtemp_daily_rr %>% group_by(Month, Year) %>% summarise(ext_hot = sum(MaxTemp > thresh))
extreme_tmax_rr
##Extreme cold 
extreme_tmin_rr <- aggregate(weather_davis$MinTemp, by = list("Month" = weather_davis$Month), FUN = function(x){quantile(x, probs = 0.9)})
names(extreme_tmin_rr)[2] <- "thresh"
mintemp_daily_rr <- merge(weather_davis, extreme_tmin_rr, by = c("Month"))
head(mintemp_daily_rr)
extreme_tmin_rr <- mintemp_daily_rr %>% group_by(Month, Year) %>% summarise(ext_cold = sum(MinTemp > thresh))
extreme_tmin_rr
##frost days 
extreme_frost_rr <- mintemp_daily_rr %>% group_by(Month, Year) %>% summarise(frost=sum(MinTemp<0))
extreme_frost_rr
##merge them together 
extreme_rr <- merge(extreme_tmax_rr, extreme_tmin_rr, by = c("Year","Month"))
extreme_rr <- merge(extreme_rr, extreme_frost_rr, by = c("Year","Month"))
head(extreme_rr)
extreme_rr_wide <- tidyr::pivot_wider(extreme_rr, names_from = Month, values_from = ext_hot:frost)
sum(is.na(extreme_rr_wide)) #0
dim(extreme_rr_wide) #12,37

#merge with monthly weather 
weather_rr_wide <- merge(weather_rr_wide, extreme_rr_wide, by = "Year")
weather_rr_wide
```
###Combine with Yield Data and plots
```{r}
weather_rr_month_yield <- merge(weather_rr_wide, yield_rr_9419, by = "Year")
weather_rr_month_yield

cor2 <- cor(weather_rr_month_yield$Yield, weather_rr_month_yield[,c(2:86)])
View(t(cor2))
ggscatter(weather_rr_month_yield, x = "MaxTemp_7", y = "Yield", add = "reg.line") +theme_bw() +  stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

ggscatter(weather_rr_month_yield, x = "srad_6", y = "yield", add = "reg.line") +theme_bw() +  stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

```

#Calculate peak VIs 
##Generate smoothed daily data
```{r}
dim(l578_rr_yield) #5334, 24
sum(is.na(l578_rr_yield)) #0
names(l578_rr_yield)
l578_rr_yield$Year_Field <- paste(l578_rr_yield$Year, l578_rr_yield$FieldID, sep = "_")
l578_rr_yield$Year_Field #"2010_6_4"

ls_field_rr <- split(l578_rr_yield, l578_rr_yield$Year_Field)
length(ls_field_rr)  #166

ls_field_rr_smooth <- list()
field_peak_rr <- data.frame("ID" = names(ls_field_rr), "Year" = 0, "peakT_EVI" = 0, "peakV_EVI"=0, "peakT_NDVI" = 0, "peakV_NDVI" = 0, "peakT_EVI2" = 0, "peakV_EVI2" = 0, "peakT_WDRVI" = 0, "peakV_WDRVI" = 0, "peakT_NDMI" = 0, "peakV_NDMI" = 0, "peakT_NIRv" = 0, "peakV_NIRv" = 0)
field_peak_rr$Year <- sapply(strsplit(field_peak_rr$ID, split = "_"), '[', 1)
field_peak_rr$FieldID1 <- sapply(strsplit(field_peak_rr$ID, split = "_"), '[', 2)
field_peak_rr$FieldID2 <- sapply(strsplit(field_peak_rr$ID, split = "_"), '[', 3)
field_peak_rr$FieldID <- paste(field_peak_rr$FieldID1, field_peak_rr$FieldID2, sep = "_")
field_peak_rr$FieldID1 <- NULL
field_peak_rr$FieldID2 <- NULL
head(field_peak_rr)


for(i in 1:length(ls_field_rr)){
  df <- ls_field_rr[[i]]
  DOY <- as.numeric(strftime(df$Date, format = "%j"))
  #field_peak_rr$County[i] <- unique(df$County)
  #EVI
  #EVI_filt <- sgolayfilt(df$EVI)
  EVI_filt <- df$EVI
  EVI_DOY <- cbind(1:365, NA)
  EVI_DOY[DOY, 2] <- EVI_filt
  EVI_smooth <- na_interpolation(x = EVI_DOY, option = "linear")
  ls_field_rr_smooth[[i]] <- data.frame("DOY"=EVI_smooth[,1], "EVI" = EVI_smooth[,2])
  #ls_field_rr_smooth[[i]]$Area_acre <- unique(df$Area_acre)
  ls_field_rr_smooth[[i]]$Year <- unique(df$Year)
  #ls_field_rr_smooth[[i]]$County <- unique(df$County)
  ##find peaks during June-Sept
  EVI_smooth_peak <- subset(ls_field_rr_smooth[[i]], DOY> 150 & DOY < 273)
  field_peak_rr$peakV_EVI[i] <- max(EVI_smooth_peak$EVI)
  field_peak_rr$peakT_EVI[i] <- which.max(EVI_smooth_peak$EVI)+150 
  #NDVI
  #NDVI_filt <- sgolayfilt(df$NDVI)
  NDVI_filt <- df$NDVI
  NDVI_DOY <- cbind(1:365, NA)
  NDVI_DOY[DOY, 2] <- NDVI_filt
  NDVI_smooth <- na_interpolation(x = NDVI_DOY, option = "linear")
  ls_field_rr_smooth[[i]]$NDVI <- NDVI_smooth[,2]
  NDVI_smooth_peak <- subset(ls_field_rr_smooth[[i]], DOY > 150 & DOY < 273)
  field_peak_rr$peakV_NDVI[i] <- max(NDVI_smooth_peak$NDVI)
  field_peak_rr$peakT_NDVI[i] <- which.max(NDVI_smooth_peak$NDVI)+150
  #EVI2
  #EVI2_filt <- sgolayfilt(df$EVI2)
  EVI2_filt <- df$EVI2
  EVI2_DOY <- cbind(1:365, NA)
  EVI2_DOY[DOY, 2] <- EVI2_filt
  EVI2_smooth <- na_interpolation(x = EVI2_DOY, option = "linear")
  ls_field_rr_smooth[[i]]$EVI2 <- EVI2_smooth[,2]
  EVI2_smooth_peak <- subset(ls_field_filt2_smooth[[i]], DOY > 150 & DOY < 273)
  field_peak_rr$peakV_EVI2[i] <- max(EVI2_smooth_peak$EVI2)
  field_peak_rr$peakT_EVI2[i] <- which.max(EVI2_smooth_peak$EVI2)+150
  #WDRVI
  #WDRVI_filt <- sgolayfilt(df$WDRVI)
  WDRVI_filt <- df$WDRVI
  WDRVI_DOY <- cbind(1:365, NA)
  WDRVI_DOY[DOY, 2] <- WDRVI_filt
  WDRVI_smooth <- na_interpolation(x = WDRVI_DOY, option = "linear")
  ls_field_rr_smooth[[i]]$WDRVI <- WDRVI_smooth[,2]
  WDRVI_smooth_peak <- subset(ls_field_filt2_smooth[[i]], DOY > 150 & DOY < 273)
  field_peak_rr$peakV_WDRVI[i] <- max(WDRVI_smooth_peak$WDRVI)
  field_peak_rr$peakT_WDRVI[i] <- which.max(WDRVI_smooth_peak$WDRVI)+150
  #NDMI
  #NDMI_filt <- sgolayfilt(df$NDMI)
  NDMI_filt <- df$NDMI
  NDMI_DOY <- cbind(1:365, NA)
  NDMI_DOY[DOY, 2] <- NDMI_filt
  NDMI_smooth <- na_interpolation(x = NDMI_DOY, option = "linear")
  ls_field_rr_smooth[[i]]$NDMI <- NDMI_smooth[,2]
  NDMI_smooth_peak <- subset(ls_field_filt2_smooth[[i]], DOY > 150 & DOY < 273)
  field_peak_rr$peakV_NDMI[i] <- max(NDMI_smooth_peak$NDMI)
  field_peak_rr$peakT_NDMI[i] <- which.max(NDMI_smooth_peak$NDMI)+150
  #NIRv
  #NIRv_filt <- sgolayfilt(df$NIRv)
  NIRv_filt <- df$NIRv
  NIRv_DOY <- cbind(1:365, NA)
  NIRv_DOY[DOY, 2] <- NIRv_filt
  NIRv_smooth <- na_interpolation(x = NIRv_DOY, option = "linear")
  ls_field_rr_smooth[[i]]$NIRv <- NIRv_smooth[,2]
  NIRv_smooth_peak <- subset(ls_field_filt2_smooth[[i]], DOY > 150 & DOY < 273)
  field_peak_rr$peakV_NIRv[i] <- max(NIRv_smooth_peak$NIRv)
  field_peak_rr$peakT_NIRv[i] <- which.max(NIRv_smooth_peak$NIRv)+150
}

head(field_peak_rr)
tail(field_peak_rr)
dim(field_peak_rr)  #166,15
ls_field_rr_smooth[[1]]

summary(field_peak_rr$peakT_EVI)
summary(field_peak_rr$peakV_EVI)
hist(field_peak_rr$peakV_EVI)
sum(field_peak_rr$peakV_EVI<0) #6
sum(field_peak_rr$peakV_EVI<0.2) #165
sum(field_peak_rr$peakV_EVI<0.3) #165
sum(field_peak_rr$peakV_EVI<0.4) #47
sum(field_peak_rr$peakV_NDVI<0.4) #0
sum(field_peak_rr$peakV_NDVI<0.5) #10

sum(field_peak_rr$peakV_EVI<=0.3) #0
sum(field_peak_rr$peakT_EVI==151) #606
sum(field_peak_rr$peakT_EVI==272) #1

#add name to the list
names(ls_field_rr)
names(ls_field_rr_smooth) <- names(ls_field_rr)

```

##Merge peakV with Yield 
```{r}
field_peak_rr_yield <- base::merge(field_peak_rr, yield_rr_9419, by = c("Year","FieldID"), all.x = TRUE, all.y = FALSE)
dim(field_peak_rr_yield) #176,21
dim(field_peak_rr)  #166,15
dim(yield_rr_9419)  #364,8
View(field_peak_rr_yield)

#names(field_peak_rr_yield)[21] <- "Yield"
cor3 <- cor(field_peak_rr_yield$Yield, field_peak_rr_yield[,c(4:15)])
View(t(cor3))
#p1 = ggscatter(county_peak_monthweighted_yield, x = "peakV_NIRv", y = "Yield", add = "reg.line") + theme_bw() + stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")

```

##Exploratory plots
```{r}
names(field_peak_rr)
ggplot(field_peak_rr, aes(x = peakT_EVI, y = peakV_EVI)) + geom_point()
dim(field_peak_rr)
ggscatter(field_peak_rr_yield, x = "peakV_EVI", y = "Yield", add = "reg.line") + theme_bw() +  stat_cor(aes(label =  paste(..rr.label.., ..p.label.., sep = "~`,`~"))) + ylab("Yield (tons/acre)")
ggscatter(field_peak_rr_yield, x = "peakV_NDVI", y = "Yield")
ggscatter(field_peak_rr_yield, x = "peakV_NIRv", y = "Yield") 
ggscatter(field_peak_rr_yield, x = "peakV_NDVI", y = "Yield")

```

##Analyze Smoothed daily VIs
```{r}
length(ls_field_rr_smooth) #167
head(ls_field_rr_smooth[[1]])
names(ls_field_rr_smooth)
names(ls_field_rr_smooth[[1]])

#make it a big dataframe 
for(i in 1:length(ls_field_rr_smooth)){
  df <- ls_field_rr_smooth[[i]]
  df$Year_Field <- names(ls_field_rr_smooth)[i]
  df$Year <- sapply(strsplit(df$Year_Field, split= "_"), '[',1)
  df$FieldID1 <- sapply(strsplit(df$Year_Field, split= "_"), '[',2)
  df$FieldID2 <- sapply(strsplit(df$Year_Field, split= "_"), '[',3)
  df$FieldID <- paste(df$FieldID1, df$FieldID2, sep = "_")
  df$FieldID1 <- NULL
  df$FieldID2 <- NULL
  ls_field_rr_smooth[[i]] <- df
}
df_field_rr_smooth <- do.call(rbind, ls_field_rr_smooth)
dim(df_field_rr_smooth)  #60590,10
length(ls_field_rr_smooth)  #166
dim(subset(yield_rr_9419, Year >= 2008)) #167,6

#merge with yield data
df_field_rr_yield <- base::merge(df_field_rr_smooth, yield_rr_9419, by = c("Year", "FieldID", "Year_Field"))
dim(df_field_rr_smooth) #60590,10
dim(df_field_rr_yield)  #60590, 13
head(df_field_rr_yield)


#planting date and harvest date
plantdate_rr <- df_field_rr_yield %>% group_by(Year) %>% summarise(plant_date= unique(plant_date))
plantdate_rr$plant_date_DOY <- as.numeric(strftime(plantdate_rr$plant_date, format = "%j"))
harvdate_rr <- df_field_rr_yield %>% group_by(Year) %>% summarise(harv_date= unique(harv_date))
harvdate_rr$harv_date_DOY <- as.numeric(strftime(harvdate_rr$harv_date, format = "%j"))

plant_harv_date_rr <- merge(plantdate_rr, harvdate_rr, by = "Year")

ggplot(plant_harv_date_rr, aes(x = Year, y = harv_date_DOY)) + geom_point() + geom_point(aes(x = Year, y = plant_date_DOY), color = "red") + theme_bw() + ylab("DOY")

plant_harv_date_rr$grow_length <- plant_harv_date_rr$harv_date_DOY - plant_harv_date_rr$plant_date_DOY

ggplot(plant_harv_date_rr, aes(x = Year, y = grow_length))+ geom_point() + ylab("DOY")

#GDD from planting to harvest

```
###Plot the time sereis VIs
```{r}
head(df_field_rr_yield)
ggplot(subset(df_field_rr_yield, Year == 2019 & DOY > 100 & DOY < 300), aes(x = DOY, y = NDVI, color = FieldID)) + geom_point(size = 0.1) + geom_smooth(se = FALSE) + theme_bw()# + facet_wrap()

ggplot(subset(df_field_rr_yield, Year == 2019 & DOY > 100 & DOY < 300), aes(x = DOY, y = NDVI, color = FieldID)) + geom_point(size = 0.05) + geom_smooth(se = FALSE) + theme_bw()+ facet_wrap(~FieldID) + geom_vline(xintercept = 121) + geom_vline(xintercept = 250)

ggplot(subset(l578_rr_yield, Year == 2019 & DOY > 100 & DOY < 300), aes(x = DOY, y = NDVI, color = FieldID)) + geom_point()  + theme_bw()+ facet_wrap(~FieldID) + geom_vline(xintercept = 121) + geom_vline(xintercept = 250)

ggplot(subset(l578_rr_yield, Year == 2019 & DOY > 100 & DOY < 300), aes(x = DOY, y = EVI, color = FieldID)) + geom_point()  + theme_bw()+ geom_vline(xintercept = 121, color = "darkgreen") + geom_vline(xintercept = 250, color = "brown") 

#EVI
ggplot(subset(l578_rr_yield,  DOY > 100 & DOY < 300), aes(x = DOY, y = EVI, FieldID)) + geom_point(size = 0.05)  + theme_bw()  + geom_vline(data = l578_rr_yield, aes(xintercept = plant_DOY), color = "darkgreen")+ geom_vline(data = l578_rr_yield, aes(xintercept = harv_DOY), color = "brown")+ facet_wrap(~Year)
#NIRv
ggplot(subset(l578_rr_yield,  DOY > 100 & DOY < 300), aes(x = DOY, y = NIRv, FieldID)) + geom_point(size = 0.05)  + theme_bw()  + geom_vline(data = l578_rr_yield, aes(xintercept = plant_DOY), color = "darkgreen")+ geom_vline(data = l578_rr_yield, aes(xintercept = harv_DOY), color = "brown")+ facet_wrap(~Year)




ggplot(subset(df_field_smooth))

head(l578_rr_yield) 

cor4 <- l578_rr_yield %>% group_by(Year) %>% summarise(cor(Yield, NDVI))
cor4 <- data.frame()

head(df_field_rr_yield)
head(df_field_rr_smooth)

ggplot(subset(df_field_rr_yield, Year == 2019 & DOY > 100 & DOY < 300), aes(x = DOY, y = EVI, color = FieldID)) + geom_point()  + theme_bw()+ geom_vline(xintercept = 121, color = "darkgreen") + geom_vline(xintercept = 250, color = "brown") + facet_wrap(~FieldID)


ggplot(subset(l578_rr_yield, Year == 2019 & DOY > 100 & DOY < 300), aes(x = DOY, y = EVI, color = FieldID)) + geom_point()  + theme_bw()+ geom_vline(xintercept = 121, color = "darkgreen") + geom_vline(xintercept = 250, color = "brown") + facet_wrap(~FieldID)


```
###Merge daily VIs with weather data
```{r}
head(df_field_rr_yield)
head(weather_davis)
head(gdd_daily_rr)
dim(df_field_rr_yield)  #60955,13
dim(weather_davis)  #4351,11

df_field_rr_yield_weather <- merge(df_field_rr_yield, weather_davis, by = c("Year","DOY"))
head(df_field_rr_yield_weather)
dim(df_field_rr_yield_weather)  #60524,22
df_field_rr_yield_weather <- merge(df_field_rr_yield_weather, gdd_daily_rr[,c("Year","GDD","DOY")], by = c("Year","DOY"))
head(df_field_rr_yield_weather)
dim(df_field_rr_yield_weather)  #60524,23


a <- df_field_rr_yield_weather %>% group_by(Year_Field) %>% arrange(DOY) %>% summarise(EVI_cum = cumsum(EVI),NDVI_cum = cumsum(NDVI),EVI2_cum = cumsum(EVI2),WDRVI_cum = cumsum(WDRVI),NDMI_cum = cumsum(NDMI), NIRv_cum = cumsum(NIRv), srad_sum = cumsum(srad), Year = Year, DOY = DOY)

dim(a) #60524,9
head(a)

df_field_rr_yield_weather <- merge(df_field_rr_yield_weather, a, by = c("Year_Field","Year","DOY"))
dim(df_field_rr_yield_weather) 
head(df_field_rr_yield_weather)

df_field_rr_yield_weather$plant_DOY <- as.numeric(strftime(df_field_rr_yield_weather$plant_date, format = "%j"))
df_field_rr_yield_weather$harv_DOY <- as.numeric(strftime(df_field_rr_yield_weather$harv_date, format = "%j"))

subset(df_field_rr_yield_weather, DOY>plant_DOY)
```

###Cumulative VIs
```{r}
class(df_field_rr_yield_weather$plant_date)
as.numeric(strftime(df$Date, format = "%j"))

b <- df_field_rr_yield_weather %>% group_by(Year) %>% summarise(cor(Yield, NDVI))


```

##GDDs 
###From transplanting to harvest
```{r}
head(weather_davis)
gdd_daily_rr <- weather_davis %>% group_by(Year) %>% summarise("Date" = Date,"MaxTemp" = MaxTemp, "MinTemp" = MinTemp,"GDD" = pollen::gdd(tmax = MaxTemp, tmin = MinTemp, tbase = 10, tbase_max = 30, type = "C"))
head(gdd_daily_rr)
#add DOY column 
gdd_daily_rr$DOY <- as.numeric(strftime(gdd_daily_rr$Date, format = "%j"))

plantdate_rr <- merge(plantdate_rr, gdd_daily_rr, by.x = c("Year","plant_date_DOY"), by.y = c("Year", "DOY"))
harvdate_rr <- merge(harvdate_rr, gdd_daily_rr, by.x = c("Year","harv_date_DOY"), by.y = c("Year", "DOY"))
dim(plantdate_rr) #12,7
dim(harvdate_rr)#19,7

plant_harv_date_rr <- merge(plantdate_rr, harvdate_rr, by = "Year")
dim(plant_harv_date_rr) #19,13
head(plant_harv_date_rr)
plant_harv_date_rr$GDD_cum <- (plant_harv_date_rr$GDD.y - plant_harv_date_rr$GDD.x)
ggplot(plant_harv_date_rr, aes(x = Year, y= GDD_cum)) + geom_point() + theme_bw() + geom_abline(intercept = 1300, slope = 0, color = "red") + ylab("GDD from Plant to Harvest")
View(plant_harv_date_rr)
names(plant_harv_date_rr)
head(plant_harv_date_rr)
plant_harv_date_rr <- plant_harv_date_rr[,c("Year","plant_date_DOY","plant_date", "GDD.x","harv_date_DOY","harv_date","GDD.y","GDD_cum")]
names(plant_harv_date_rr)[c(4,7,8)] <- c("GDD_plant","GDD_harv","GDD_plant_harv")

dim(plantdate_rr) #12,3
dim(gdd_daily_rr)
plantdate_rr

str(plant_harv_date_rr)
plant_harv_date_rr <- plant_harv_date_rr %>% group_by(Year) %>% summarise(GDD_plant = mean(GDD_plant), GDD_harv = mean(GDD_harv), GDD_plant_harv = mean(GDD_plant_harv))
ggplot(plant_harv_date_rr, aes(x = Year, y= GDD_plant_harv)) + geom_point() + theme_bw() + geom_abline(intercept = 1300, slope = 0, color = "red") + ylab("GDD from Plant to Harvest")

```

###from transplanting to peak
```{r}
head(field_peak_rr_yield)
peakdate_rr <- merge(field_peak_rr_yield[,c("Year","FieldID","peakT_NDVI")], gdd_daily_rr, by.x=c("Year","peakT_NDVI"), by.y = c("Year","DOY"))
head(a)
head(plantdate_rr)
peakdate_rr <- merge(peakdate_rr, plantdate_rr, by = "Year")
head(peakdate_rr)

peakdate_rr$GDD_cum <- peakdate_rr$GDD.x - peakdate_rr$GDD.y
peakdate_rr$GDD_cum
hist(peakdate_rr$GDD_cum, xlab = "Growing Degree Days", main = "Histogram of GDD from Transplanting to Peak in RR") 
abline(v = 800, col = "red")
```

##Cumulative VIs
```{r}
head(weather_davis)
head(weather_)
```


##Calculate county-level average daily VIs
```{r}
head(weather_davis)
```

```{r}
length(ls_field_filt2_smooth_filt) #49456
dim(field_peak_filt)  #49576
head(ls_field_filt2_smooth_filt[[1]])

df_field_smooth <- do.call(rbind, ls_field_filt2_smooth_filt)


#calculate the weighted ratio 
df_temp <- field_peak_filt %>% group_by(Area_acre, Year) %>% summarise("Area_acre"= unique(Area_acre), "County" = unique(County))
head(df_temp)
df_temp$Area_acre <- as.numeric(df_temp$Area_acre)
df_temp <- aggregate(df_temp[,"Area_acre"], by = list("County" = df_temp$County, "Year" = df_temp$Year), FUN = sum)
df_temp$Area_acre <- df_temp$Area_acre/4046.8564224
#add yield data to dataframe
df_temp <- merge(df_temp, yield_county, by = c("County","Year"))
names(df_temp)[c(3,6)] <- c("Area_NASS", "Area_Report")
ggplot(df_temp, aes(x = Area_NASS, y = Area_Report)) + geom_point()
county_peak_monthweighted <- merge(df_temp, field_peak_filt, by = c("Year", "County"))
head(county_peak_monthweighted)
dim(county_peak_monthweighted) #45881,25
county_peak_monthweighted$Area_acre<- as.numeric(county_peak_monthweighted$Area_acre)
#calculate area ratio 
county_peak_monthweighted$Area_ratio <- county_peak_monthweighted$Area_acre/4046.8564224/county_peak_monthweighted$Area_NASS
county_peak_monthweighted <- county_peak_monthweighted %>% group_by(County, Year) %>% summarise("peakT_EVI" = weighted.mean(peakT_EVI, Area_ratio),"peakV_EVI" = weighted.mean(peakV_EVI, Area_ratio), "peakT_NDVI" = weighted.mean(peakT_NDVI), "peakV_NDVI" = weighted.mean(peakV_NDVI), "peakT_EVI2" = weighted.mean(peakT_EVI2), "peakV_EVI2" = weighted.mean(peakV_EVI2), "peakT_WDRVI" = weighted.mean(peakT_WDRVI), "peakV_WDRVI" = weighted.mean(peakV_WDRVI), "peakT_NDMI" = weighted.mean(peakT_NDMI), "peakV_NDMI" = weighted.mean(peakV_NDMI), "peakT_NIRv" = weighted.mean(peakT_NIRv), "peakV_NIRv" = weighted.mean(peakV_NIRv))
head(county_peak_monthweighted)
#combine with yield 
county_peak_monthweighted_yield <- merge(county_peak_monthweighted, yield_county, by = c("Year","County"))
dim(county_peak_monthweighted) #162, 14
dim(county_peak_monthweighted_yield) #140, 22

```


#----------------Validatino with RR: End--------------------------



#-------------
#-------------

#--------------Not useful below--------------------
#Yield model all together
##Preprocessing 
```{r}
set.seed(777)
traincrtl <- trainControl(method = "cv", number = 10)

```

##Exploration 
```{r}
names(l578_county_monthweighted_yield_weather)
dim(l578_county_monthweighted_yield_weather) #140,240
sum(is.na(l578_county_monthweighted_yield_weather)) #36


lm1 <- lm(Yield ~ NIRv_6 + NDVI_8 + srad_7, l578_county_monthweighted_yield_weather)
summary(lm1)


names(county_peak_monthweighted_yield)
dim(county_peak_monthweighted_yield) #140, 22
sum(is.na(county_peak_monthweighted_yield)) #0 
lm2 <- lm(Yield ~ peakV_NIRv + peakT_NIRv, county_peak_monthweighted_yield)
summary(lm2) #R2 = 0.4407

names(l578_county_monthweighted_yield_weather)

#ML
traincrtl <- trainControl(method = "cv", number = 10)

#RF
rffit_vi_weather <- train(Yield~NIRv_6 + EVI_5 + MinTemp_7 + NDVI_8 + ext_cold_4, data = l578_county_monthweighted_yield_weather, method = "rf", trControl = traincrtl, tuneLength = 25, verbose = FALSE)  #r^2 = 0.557
plot(varImp(rffit_vi_weather))
partial(rffit_vi_weather, pred.var = c("NIRv_6"), chull = TRUE, plot = TRUE)
partial(rffit_vi_weather, pred.var = c("EVI_5"), chull = TRUE, plot = TRUE)

?plotPartial


#SVM
svmfit_vi_weather <- train(Yield~NIRv_6 + EVI_5 + MinTemp_7 + NDVI_8 + ext_cold_4, data = l578_county_monthweighted_yield_weather, method = "svmRadial", trControl = traincrtl, tuneLength = 25, verbose = FALSE)  #r^2 = 0.53
svmfit_vi_weather

#plsr 
plsfit_vi_weather <- train(Yield~NIRv_6 + EVI_5 + MinTemp_7 + NDVI_8 + ext_cold_4, data = l578_county_monthweighted_yield_weather, method = "pls", trControl = traincrtl, tuneLength = 15)
plsfit_vi_weather  #0.459

#lm
lm_vi_weather <- train(Yield~NIRv_6 + EVI_5 + MinTemp_7 + NDVI_8 + ext_cold_4, data = l578_county_monthweighted_yield_weather, method = "lm", trControl = traincrtl)
lm_vi_weather  #0.478


#regression tree 
rpart_vi_weather <- train(Yield~NIRv_6 + EVI_5 + MinTemp_7 + NDVI_8 + ext_cold_4, data = l578_county_monthweighted_yield_weather, method = "rpart", trControl = traincrtl, tuneLength = 25)
plot(rpart_vi_weather)

#gbm
gbm_vi_weather <- train(Yield~NIRv_6 + EVI_5 + MinTemp_7 + NDVI_8 + ext_cold_4, data = l578_county_monthweighted_yield_weather, method = "gbm", trControl = traincrtl, tuneLength = 25, verbose = FALSE)
gbm_vi_weather  #R2< 0.45

#



#rffit_vi1 <- train(Yield~., data = training[,c(4,6:85)], method = "rf", trControl = traincrtl, tuneLength = 25, verbose = FALSE)

```

##Only VIs (weighted average)
###Preprocessing 
```{r}
names(l578_county_monthweighted_yield)
dim(l578_county_monthweighted_yield) #140,106
dim(l578_county_monthweighted_yield_filt1) #137,106
sum(is.na(l578_county_monthweighted_yield)) #0

#solve multicollinearity problem
cor_cut_vis <- findCorrelation(cor(l578_county_monthweighted_yield_filt1[,c(6:101)]), cutoff = 0.7, verbose = TRUE, names = TRUE)
l578_county_monthweighted_yield_filt2 <- cbind(l578_county_monthweighted_yield_filt1[,c(1:5)], l578_county_monthweighted_yield_filt1[,c(6:101)][cor_cut_vis])

```
###Train the model
```{r}
set.seed(888) 
intrain <- createDataPartition(y = l578_county_monthweighted_yield_filt2$Yield, p = 0.7, list = FALSE)
training <- l578_county_monthweighted_yield_filt2[intrain,]
testing <- l578_county_monthweighted_yield_filt2[-intrain,]
traincrtl <- trainControl(method = "cv", number = 10)


rffit_vi1 <- train(Yield~., data = training[,c(4,6:85)], method = "rf", trControl = traincrtl, tuneLength = 25, verbose = FALSE)
rffit_vi1  #.050
predictors(rffit_vi1)
cor(predict(rffit_vi1, testing),testing$Yield)^2  #0.519
RMSE(predict(rffit_vi1, testing),testing$Yield) #3.972

svm_vi1 <- train(Yield~., data = training[,c(4,6:85)], method = "svmRadial", trControl = traincrtl, tuneLength = 25, verbose = FALSE)
svm_vi1
predictors(svm_vi1)
cor(predict(svm_vi1, testing), testing$Yield)^2 #0.552
RMSE(predict(svm_vi1, testing), testing$Yield) #4.204


```
##VIs + weather (weighted monthly average)
```{r}
#solve multicollinearity problem
cor_cut_vis <- findCorrelation(cor(l578_county_monthweighted_yield_filt1_weather[,c(6:235)]), cutoff = 0.7, verbose = TRUE, names = TRUE)
sum(is.na(l578_county_monthweighted_yield_filt1_weather)) 
l578_county_monthweighted_yield_filt2 <- cbind(l578_county_monthweighted_yield_filt1[,c(1:5)], l578_county_monthweighted_yield_filt1[,c(6:101)][cor_cut_vis])

```
###Treain the model
```{r}
set.seed(888) 
intrain <- createDataPartition(y = l578_county_monthweighted_yield_filt1_weather$Yield, p = 0.7, list = FALSE)
training <- l578_county_monthweighted_yield_filt1_weather[intrain,]
testing <- l578_county_monthweighted_yield_filt1_weather[-intrain,]
traincrtl <- trainControl(method = "cv", number = 10)


rffit_vi1 <- train(Yield~., data = training[,c(4,6:161, 164:235)], method = "rf", trControl = traincrtl, tuneLength = 25, verbose = FALSE)
rffit_vi1  #.050
predictors(rffit_vi1)
cor(predict(rffit_vi1, testing),testing$Yield)^2  #0.519
RMSE(predict(rffit_vi1, testing),testing$Yield) #3.972

svm_vi1 <- train(Yield~., data = training[,c(4,6:85)], method = "svmRadial", trControl = traincrtl, tuneLength = 25, verbose = FALSE)
svm_vi1
predictors(svm_vi1)
cor(predict(svm_vi1, testing), testing$Yield)^2 #0.552
RMSE(predict(svm_vi1, testing), testing$Yield) #4.204


```

##Unweighted Monthly Average
###Preprocessing 
```{r}
names(l578_county_month_yield_filt1)
dim(l578_county_month_yield_filt1) #152, 109
sum(is.na(l578_county_month_yield_filt1)) #39
#remove columns with missing values 
l578_county_month_yield_filt2 <- na.omit(l578_county_month_yield_filt1)
dim(l578_county_month_yield_filt2)  #149, 109 

#remove NAs
ggplot(l578_county_month_yield_filt1, aes(x = Year, y = Yield, color = County)) + geom_point()
ggplot(a, aes(x = Year, y = Yield, color = County)) + geom_point()

names(l578_county_month_yield)
#remove bright temperature columns 
names(l578_county_month_yield_filt2)[46:53]
l578_county_month_yield_filt2[,c(46:53)] <- NULL
names(l578_county_month_yield_filt2)
#solve multicollinearity problem 

cor_cut_vis <- findCorrelation(cor(l578_county_month_yield_filt2[,c(6:101)]), cutoff = 0.7, verbose = TRUE, names = TRUE)
l578_county_month_yield_filt2 <- cbind(l578_county_month_yield_filt2[,c(1:5)], l578_county_month_yield_filt2[,c(6:101)][cor_cut_vis])
dim(l578_county_month_yield_filt2) #149, 85


```
###Feature selection 
```{r}
set.seed(666) 

intrain <- createDataPartition(y = l578_county_month_yield_filt2$Yield, p = 0.7, list = FALSE)
training <- l578_county_month_yield_filt2[intrain,]
testing <- l578_county_month_yield_filt2[-intrain,]
traincrtl <- trainControl(method = "cv", number = 10)

to_test <- seq(1,85, by =5)
rfectrl <- rfeControl(functions = rfFuncs, method = "cv", number = 10,verbose = FALSE)
fs_rfe <- rfe(x = l578_county_month_yield_filt2[,c(6:85)], y = l578_county_month_yield_weather$Yield, rfeControl = rfectrl, sizes = c(to_test))

select_rfe <- predictors(fs_rfe)
```
###Train the model
```{r}
names(training)
rffit_vi1 <- train(Yield~., data = training[,c(4,6:85)], method = "rf", trControl = traincrtl, tuneLength = 25, verbose = FALSE)
rffit_vi1  #.050
predictors(rffit_vi1)
cor(predict(rffit_vi1, testing),testing$Yield)^2  #0.475
RMSE(predict(rffit_vi1, testing),testing$Yield) #4.54

rffit_vi2 <- train(Yield~., data = training[,c(4,6:85)], method = "rf", trControl = traincrtl, tuneLength = 25, verbose = FALSE)

svm_vi1 <- train(Yield~., data = training[,c(4,6:85)], method = "svmRadial", trControl = traincrtl, tuneLength = 25, verbose = FALSE)
svm_vi1
predictors(svm_vi1)
cor(predict(svm_vi1, testing), testing$Yield)^2 #0.552
RMSE(predict(svm_vi1, testing), testing$Yield) #4.204

gbm_vi1 <- train(Yield~., data = training[,c(4,6:85)], method = "gbm", trControl = traincrtl, tuneLength = 25, verbose = FALSE)
gbm_vi1
cor(predict(gbm_vi1, testing), testing$Yield)^2 #0.409
RMSE(predict(gbm_vi1, testing), testing$Yield)  #4.833

lm_vi1 <- train(Yield~., data = training[,c(4,6:85)], method = "lmStepAIC", trControl = traincrtl, tuneLength = 25, verbose = FALSE)
lm_vi1

```

##Preprocessing
```{r}
#cor(l578_county_month_yield_weather$Yield, l578_county_month_yield_weather[,c(97:120)])

#filter out high correlated ones 
#check variable correlation higher than 0.7
cor_cut <- findCorrelation(cor(l578_county_month_yield_weather[,c(6:132)]), cutoff = 0.7, verbose =  TRUE, names = TRUE, exact = ncol(l578_county_month_yield_weather[,c(6:132)]))
l578_county_month_yield_weather <- cbind(l578_county_month_yield_weather[,c(1:5)],l578_county_month_yield_weather[,c(6:120)][cor_cut])

#feature selection 
rfectrl <- rfeControl(functions = rfFuncs, method = "cv", verbose = FALSE)
lmprofile <- rfe(x = l578_county_month_yield_weather[,c(6:90)], y = l578_county_month_yield_weather$Yield, rfeControl = rfectrl)
lmprofile
#top 5 varaibles: NIR_5, NIRv_6, NIR_6, Blue_4, EVI2_6

```

##with only VIs 
```{r}
set.seed(777) 

intrain <- createDataPartition(y = l578_county_month_yield_weather$Yield, p = 0.7, list = FALSE)
training <- l578_county_month_yield_weather[intrain,]
testing <- l578_county_month_yield_weather[-intrain,]
traincrtl <- trainControl(method = "cv", number = 5)

#Ridge
ridgefit_1 <-  train(Yield~., data = training[,c(4,6:90)], method = "ridge", trControl = traincrtl, tuneLength = 15, verbose = FALSE)
ridgefit_1
cor(predict(ridgefit_1, testing), testing$Yield)^2  #0.562

#RF
rffit_1 <- train(Yield~., data = training[,c(4,6:231)], method = "rf", trControl = traincrtl, tuneLength = 15)
plot(varImp(rffit_1))
cor(predict(rffit_1, testing), testing$Yield)^2  #0.52

#PLSR
plsfit_1 <- train(Yield~., data = training[,c(4,6:90)], method = "pls", trControl = traincrtl, tuneLength = 15, preProc = c("center", "scale"))
plsfit_1
ggplot(plsfit_1)
pred_pls1 <- predict(plsfit_1, testing)

#
```

##VIs + weather
```{r}
set.seed(77)

intrain <- createDataPartition(y = l578_county_month_yield_weather$Yield, p = 0.7, list = FALSE)
training <- l578_county_month_yield_weather[intrain,]
testing <- l578_county_month_yield_weather[-intrain,]
nrow(training); nrow(testing) #96,38

crtl <- trainControl(method = "repeatedcv", repeats = 5)

#variable selection before RF


#random forest
rffit <- train(Yield ~., data = training[,c(4,6:120)], method = "rf", trControl = crtl, verbose = FALSE)

#stochastic gradient boosting

#linear regression 

#svm

#ann


```


##Only 2013
```{r}
ls_field_2013 <- split(l8sr_ts_df_2013, l8sr_ts_df_2013$ID)
length(ls_field_2013) #5223

#filter out the 
yesno_2013 <- rep(0, length(ls_field_2013))
for(i in 1:length(ls_field_2013)){
  #Filter out 
  df_peak <- subset(ls_field_2013[[i]], Date< "2013-09-01" & Date > "2013-06-01")
  if(max(df_peak$NDVI)<0.5){
    yesno_2013[i] <- (-1)
  }
  if(max(df_peak$NDVI)>=0.5){
    yesno_2013[i] <- 1
  }
}
length(which(yesno_2013==-1)) #61
length(which(yesno_2013==1)) #5162
ls_field_2013_filt1 <- ls_field_2013[which(yesno_2013==1)]

#extract information 
field_2013_sum <- data.frame("ID" = names(ls_field_2013_filt1),"Year" = 2013, "UD_T"=0,"UD_V"=0, "SD_T"=0,"SD_V"=0, "DD_T"=0,"DD_V"=0,"RD_T" = 0, "RD_V" = 0, "max_T" = 0, "max_V"=0, "LengthGS"=0)
for(i in 1:length(ls_field_2013_filt1)){
  #subset
  df <- ls_field_2013_filt1[[i]]
  #sort by date
  df <- df[order(df$Date),]
  #sgolay filter 
  #EVI_filt <- sgolayfilt(df$EVI)
  #phenofit package 
  curve_fit <- curvefit(y = df$EVI, t = yday(df$Date), tout = 1:365, methods = "Gu")
  pheno_stage <- get_pheno.fFITs(curve_fit, method = "Gu")
  fitted_value <- curve_fit$fFIT$Gu$zs$iter2
  #Extract useful information 
  ##Upturn date
  if(sum(is.na(pheno_stage$GU))==0){
    field_2013_sum$UD_T[i] <- pheno_stage$GU[1]
    field_2013_sum$UD_V[i] <- fitted_value[pheno_stage$GU[1]]
    ##stabilization date
    field_2013_sum$SD_T[i] <- pheno_stage$GU[2]
    field_2013_sum$SD_V[i] <- fitted_value[pheno_stage$GU[2]]
    ##downturn date
    field_2013_sum$DD_T[i] <- pheno_stage$GU[3]
    field_2013_sum$DD_V[i] <- fitted_value[pheno_stage$GU[3]]
    ##recession date 
    field_2013_sum$RD_T[i] <- pheno_stage$GU[4]
    field_2013_sum$RD_V[i] <- fitted_value[pheno_stage$GU[4]]
    #maximum value 
    field_2013_sum$max_T[i] <- pheno_stage$GU[2]+which.max(fitted_value[pheno_stage$GU[2]:pheno_stage$GU[3]])-1
    field_2013_sum$max_V[i] <- max(fitted_value[pheno_stage$GU[2]:pheno_stage$GU[3]])
    #length of gs 
    field_2013_sum$LengthGS[i] <- field_2013_sum$RD_T[i] - field_2013_sum$UD_T[i]
  }
  else{
    field_2013_sum[i,] <- NA
  }
  
}

field_2013_sum_narm <- na.omit(field_2013_sum)
dim(field_2013_sum_narm)

#merge with other 
field_2013_sum_narm <- merge(field_2013_sum_narm, tomato_fidbound_2013, by = c("Year","ID"))
ggplot(field_2013_sum_narm, aes(x = Latitude, y = UD_T)) + geom_point()

unique(field_2013_sum_narm$NAME)
ggplot(field_2013_sum_narm, aes(x = as.factor(NAME), y = max_T)) + geom_boxplot()

a <- aggregate(field_2013_sum_narm$max_T, by = list("County"=field_2013_sum_narm$NAME), FUN = mean)
head(a)
names(a)[2] <- "EVI_max"
a$Year = 2013
a <- merge(a, yield_county_report, by = c("Year","County"))
head(a)
dim(a) #12,6
ggplot(a, aes(x = EVI_max, y = Yield,color = County)) + geom_point()


```


